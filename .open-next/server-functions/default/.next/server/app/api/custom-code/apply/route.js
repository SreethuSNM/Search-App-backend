(()=>{var e={};e.id=2,e.ids=[2],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},41600:(e,t,s)=>{"use strict";s.r(t),s.d(t,{patchFetch:()=>f,routeModule:()=>g,serverHooks:()=>y,workAsyncStorage:()=>w,workUnitAsyncStorage:()=>C});var r={};s.r(r),s.d(r,{OPTIONS:()=>d,POST:()=>h});var o=s(96559),i=s(48088),n=s(37719),a=s(32190),c=s(73488),l=s(22563),u=s(46509);function p(e){return e.headers.set("Access-Control-Allow-Origin","*"),e.headers.set("Access-Control-Allow-Methods","GET, POST, OPTIONS"),e.headers.set("Access-Control-Allow-Headers","Content-Type, Authorization"),e}async function d(){return p(new a.NextResponse(null,{status:204}))}async function h(e){try{let t;let s=e.clone(),r=await s.json();if(console.log("Request body:",r),!r.targetType||!r.scriptId||!r.location||!r.version)return p(a.NextResponse.json({error:"Missing required fields"},{status:400}));let o=await u.A.verifyAuth(e);if(!o)return console.error("Authentication failed:",o),p(a.NextResponse.json({error:"Unauthorized",details:o||"Authentication failed"},{status:401}));let i=new l.WebflowClient({accessToken:o}),n=new c.Y(i),d=await u.A.getSiteIdFromAccessToken(o);if(!d)return console.error("SiteId not found:",d),p(a.NextResponse.json({error:"Unauthorized",details:d||"SiteId failed"},{status:401}));if("site"===r.targetType)t=await n.upsertSiteCustomCode(d,r.scriptId,r.location,r.version);else{if("page"!==r.targetType)return p(a.NextResponse.json({error:"Invalid target type"},{status:400}));t=await n.upsertPageCustomCode(d,r.scriptId,r.location,r.version)}return p(a.NextResponse.json({result:t},{status:200}))}catch(e){if(e instanceof Error)return console.error("Error applying custom code:",e.message),p(a.NextResponse.json({error:"Failed to apply custom code",details:e.message},{status:500}));return console.error("Unknown error:",e),p(a.NextResponse.json({error:"Failed to apply custom code",details:"An unknown error occurred"},{status:500}))}}let g=new o.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/custom-code/apply/route",pathname:"/api/custom-code/apply",filename:"route",bundlePath:"app/api/custom-code/apply/route"},resolvedPagePath:"C:\\Seattle\\Cookie App\\Consernbit-Cloudflare-Server-Test\\cb-server\\app\\api\\custom-code\\apply\\route.ts",nextConfigOutput:"standalone",userland:r}),{workAsyncStorage:w,workUnitAsyncStorage:C,serverHooks:y}=g;function f(){return(0,n.patchFetch)({workAsyncStorage:w,workUnitAsyncStorage:C})}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46509:(e,t,s)=>{"use strict";s.d(t,{A:()=>n});var r=s(87806),o=s(77412),i=s(6426);let n={createSessionToken:async e=>{let t=new TextEncoder().encode(process.env.CLIENT_SECRET),s=await new r.P({user:e}).setProtectedHeader({alg:"HS256"}).setExpirationTime("24h").sign(t),i=await (0,o.V)(s,t);return console.log("____inside create session_____ ",s),{sessionToken:s,exp:i.payload.exp}},verifyAuth:async e=>{let t=e.headers.get("authorization"),s=t?.split(" ")[1];if(console.log("inside verify auth session",s),!s)return null;try{let e=new TextEncoder().encode(process.env.WEBFLOW_CLIENT_SECRET),{payload:t}=await (0,o.V)(s,e),r=t.user.id,{env:n}=await (0,i.DM)({async:!0}),a=await n.WEBFLOW_AUTHENTICATION.get(`user-auth:${r}`);if(a){let e=JSON.parse(a);return console.log("inside verify auth access token",e.accessToken),e.accessToken}return null}catch{return null}},getAccessToken:async e=>{try{let t=null;if("POST"===e.method?(t=(await e.json()).siteId,console.log("siteId",t)):"GET"===e.method&&(t=e.nextUrl.searchParams.get("siteId"),console.log("siteId in params",t)),!t)return console.error("No siteId provided in request."),null;let{env:s}=await (0,i.DM)({async:!0}),r=await s.WEBFLOW_AUTHENTICATION.get(t);if(console.log("stored info in kv",r),r)return JSON.parse(r).accessToken;return console.error(`No access token found for site ${t}`),null}catch(e){return console.error("Error getting access token:",e),null}},getSiteIdFromAccessToken:async e=>{try{let{env:t}=await (0,i.DM)({async:!0});for(let s of(await t.WEBFLOW_AUTHENTICATION.list()).keys){let r=await t.WEBFLOW_AUTHENTICATION.get(s.name);if(r&&JSON.parse(r).accessToken===e)return String(s.name)}return null}catch(e){return console.error("Error getting site ID:",e),null}}}},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73488:(e,t,s)=>{"use strict";s.d(t,{Y:()=>c});class r{constructor(){this.CACHE_DURATION=3e5,this.cache=new Map}static getInstance(){return r.instance||(r.instance=new r),r.instance}get(e){let t=this.cache.get(e);return t&&Date.now()-t.timestamp<this.CACHE_DURATION?t.data:null}set(e,t){this.cache.set(e,{data:t,timestamp:Date.now()})}clear(){this.cache.clear()}}class o{constructor(){this.BATCH_SIZE=3,this.DELAY_BETWEEN_BATCHES=1e3}static getInstance(){return o.instance||(o.instance=new o),o.instance}async processBatch(e,t){let s=new Map;for(let r=0;r<e.length;r+=this.BATCH_SIZE){let o=e.slice(r,r+this.BATCH_SIZE);await Promise.all(o.map(async e=>{try{let r=await t(e);s.set(e,r)}catch(t){console.error(`Error processing item ${e}:`,t),s.set(e,{})}})),r+this.BATCH_SIZE<e.length&&await new Promise(e=>setTimeout(e,this.DELAY_BETWEEN_BATCHES))}return s}}var i=s(55511),n=s.n(i);function a(e){return"object"==typeof e&&null!==e&&"statusCode"in e}class c{constructor(e){this.webflow=e,this.cache=r.getInstance(),this.rateLimiter=o.getInstance()}updateWebflowClient(e){this.webflow=e}async getRegisteredScripts(e){try{return(await this.webflow.scripts.list(e)).registeredScripts}catch(e){throw console.error("Error fetching scripts:",e),e}}async registerInlineScript(e,t){try{let s={sourceCode:t.sourceCode,canCopy:t.canCopy??!0,version:t.version,displayName:t.displayName};return await this.webflow.scripts.registerInline(e,s)}catch(e){throw console.error("Error registering inline script:",e),e}}async registerHostedScripts(e){try{console.log("Siteid in hosted script",e);let t="https://cdn.jsdelivr.net/gh/snm62/consentbit@08beb63/consentbit.js",s=await this.generateSRI(t),r={hostedLocation:t,integrityHash:s,canCopy:!0,version:"1.0.0",displayName:`Consent Script${Date.now()}`};return console.log("scriptData",r),await this.webflow.scripts.registerHosted(e,r)}catch(e){throw console.error("Error registering hosted script:",e),e}}async getSiteCustomCode(e){console.log("Using Access Token inside getSiteCustomCode:",this.webflow);let t=`site_${e}`;console.log(t);let s=this.cache.get(t);if(console.log(s),s)return s;try{console.log("inside try");let s=await this.webflow.sites.scripts.getCustomCode(e);return console.log("this is the result",s),this.cache.set(t,s),s}catch(e){throw console.error("Error fetching site custom code:",e),e}}async upsertSiteCustomCode(e,t,s,r){try{let o=await this.getExistingScripts("site",e);return console.log("[DEBUG] upsertSiteCustomCode existing scripts:",o),o=o.filter(e=>e.id!==t),console.log("[DEBUG] upsertSiteCustomCode after filter:",o),o.push({id:t,location:s,version:r}),console.log("[DEBUG] upsertSiteCustomCode final scripts array:",o),await this.webflow.sites.scripts.upsertCustomCode(e,{scripts:o})}catch(e){throw console.error("Error upserting site custom code:",e),e}}async deleteSiteCustomCode(e){try{let t=await this.webflow.sites.scripts.deleteCustomCode(e);return this.cache.set(`site_${e}`,null),t}catch(e){throw console.error("Error deleting site custom code:",e),e}}async getPageCustomCode(e){let t=`page_${e}`,s=this.cache.get(t);if(s)return s;try{let s=(await this.webflow.pages.scripts.getCustomCode(e)).scripts||[];return this.cache.set(t,s),s}catch(e){if(a(e)&&404!==e.statusCode)throw e;return[]}}async getMultiplePageCustomCode(e){let t=new Map,s=[];for(let r of e){let e=`page_${r}`,o=this.cache.get(e);o?t.set(r,o):s.push(r)}if(s.length>0)for(let[e,r]of(await this.rateLimiter.processBatch(s,async e=>{try{let t=(await this.webflow.pages.scripts.getCustomCode(e)).scripts||[];return this.cache.set(`page_${e}`,t),t}catch(e){if(a(e)&&404!==e.statusCode)throw e;return[]}})))t.set(e,r);return t}async upsertPageCustomCode(e,t,s,r){try{let o=await this.getExistingScripts("page",e);return(o=o.filter(e=>e.id!==t)).push({id:t,location:s,version:r}),await this.webflow.pages.scripts.upsertCustomCode(e,{scripts:o})}catch(e){throw console.error("Error upserting page custom code:",e),e}}async deletePageCustomCode(e){try{let t=await this.webflow.pages.scripts.deleteCustomCode(e);return this.cache.set(`page_${e}`,null),t}catch(e){throw console.error("Error deleting page custom code:",e),e}}async generateSRI(e){let t=await fetch(e),s=await t.text(),r=n().createHash("sha384").update(s).digest("base64");return`sha384-${r}`}async getExistingScripts(e,t){try{let s="site"===e?this.getSiteCustomCode:this.getPageCustomCode,r=await s.call(this,t);console.log(`[DEBUG] getExistingScripts raw response for ${e}:`,r);let o="site"===e?r.scripts||[]:r||[];return console.log(`[DEBUG] getExistingScripts processed scripts for ${e}:`,o),o}catch(t){if(console.error(`[DEBUG] getExistingScripts error for ${e}:`,t),a(t)&&404!==t.statusCode)throw t;return[]}}}},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[297,190,682,563],()=>s(41600));module.exports=r})();