(()=>{var e={};e.id=2,e.ids=[2],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},6426:(e,t,s)=>{"use strict";s.d(t,{DM:()=>o});let r=Symbol.for("__cloudflare-context__");function o(e={async:!1}){return e.async?i():function(){let e=n();if(e)return e;if(function(){let e=globalThis;return e.__NEXT_DATA__?.nextExport===!0}())throw Error("\n\nERROR: `getCloudflareContext` has been called in sync mode in either a static route or at the top level of a non-static one, both cases are not allowed but can be solved by either:\n  - make sure that the call is not at the top level and that the route is not static\n  - call `getCloudflareContext({async: true})` to use the `async` mode\n  - avoid calling `getCloudflareContext` in the route\n");throw Error(c)}()}function n(){return globalThis[r]}async function i(){let e=n();if(e)return e;{let e=await a();return function(e){globalThis[r]=e}(e),e}}async function a(){let{getPlatformProxy:e}=await import(`${"__wrangler".replaceAll("_","")}`),{env:t,cf:s,ctx:r}=await e({environment:process.env.NEXT_DEV_WRANGLER_ENV});return{env:t,cf:s,ctx:r}}let c='\n\nERROR: `getCloudflareContext` has been called without having called `initOpenNextCloudflareForDev` from the Next.js config file.\nYou should update your Next.js config file as shown below:\n\n   ```\n   // next.config.mjs\n\n   import { initOpenNextCloudflareForDev } from "@opennextjs/cloudflare";\n\n   initOpenNextCloudflareForDev();\n\n'+"   const nextConfig = { ... };\n   export default nextConfig;\n   ```\n\n"},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},41600:(e,t,s)=>{"use strict";s.r(t),s.d(t,{patchFetch:()=>m,routeModule:()=>g,serverHooks:()=>C,workAsyncStorage:()=>w,workUnitAsyncStorage:()=>f});var r={};s.r(r),s.d(r,{OPTIONS:()=>d,POST:()=>h});var o=s(96559),n=s(48088),i=s(37719),a=s(32190),c=s(73488),l=s(22563),u=s(6426);function p(e){return e.headers.set("Access-Control-Allow-Origin","*"),e.headers.set("Access-Control-Allow-Methods","GET, POST, OPTIONS"),e.headers.set("Access-Control-Allow-Headers","Content-Type, Authorization"),e}async function d(){return p(new a.NextResponse(null,{status:204}))}async function h(e){try{let t;let s=e.clone(),r=await s.json();console.log("Request body:",r);let{env:o}=await (0,u.DM)({async:!0}),n=`site-auth:${r.targetId}`;console.log("Looking for auth data with key:",n);let i=await o.WEBFLOW_AUTHENTICATION.get(n);if(console.log("Stored auth data:",i),!i)return console.error("No auth data found for key:",n),p(a.NextResponse.json({error:"Unauthorized: No authentication found",details:`No auth data found for site ${r.targetId}`},{status:401}));let d=JSON.parse(i);console.log("Parsed auth data:",d);let h=d?.accessToken;if(!h)return console.log("@@@@@@@@@@------No Access token"),console.error("No access token in auth data:",d),p(a.NextResponse.json({error:"Unauthorized",details:"No access token found in stored auth data"},{status:401}));let{targetType:g,targetId:w,scriptId:f,location:C,version:m}=r;if(console.log(g,w,f,C,m,"body"),!g||!w||!f||!C||!m)return p(a.NextResponse.json({error:"Missing required fields"},{status:400}));let y=new l.WebflowClient({accessToken:h}),x=new c.Y(y);if("site"===g)t=await x.upsertSiteCustomCode(w,f,C,m);else{if("page"!==g)return p(a.NextResponse.json({error:"Invalid target type"},{status:400}));t=await x.upsertPageCustomCode(w,f,C,m)}return p(a.NextResponse.json({result:t},{status:200}))}catch(e){if(e instanceof Error)return console.error("Error applying custom code:",e.message),p(a.NextResponse.json({error:"Failed to apply custom code",details:e.message},{status:500}));return console.error("Unknown error:",e),p(a.NextResponse.json({error:"Failed to apply custom code",details:"An unknown error occurred"},{status:500}))}}let g=new o.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/custom-code/apply/route",pathname:"/api/custom-code/apply",filename:"route",bundlePath:"app/api/custom-code/apply/route"},resolvedPagePath:"C:\\Seattle\\Cookie App\\Consernbit-Cloudflare-Server-Test\\cb-server\\app\\api\\custom-code\\apply\\route.ts",nextConfigOutput:"standalone",userland:r}),{workAsyncStorage:w,workUnitAsyncStorage:f,serverHooks:C}=g;function m(){return(0,i.patchFetch)({workAsyncStorage:w,workUnitAsyncStorage:f})}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},73488:(e,t,s)=>{"use strict";s.d(t,{Y:()=>c});class r{constructor(){this.CACHE_DURATION=3e5,this.cache=new Map}static getInstance(){return r.instance||(r.instance=new r),r.instance}get(e){let t=this.cache.get(e);return t&&Date.now()-t.timestamp<this.CACHE_DURATION?t.data:null}set(e,t){this.cache.set(e,{data:t,timestamp:Date.now()})}clear(){this.cache.clear()}}class o{constructor(){this.BATCH_SIZE=3,this.DELAY_BETWEEN_BATCHES=1e3}static getInstance(){return o.instance||(o.instance=new o),o.instance}async processBatch(e,t){let s=new Map;for(let r=0;r<e.length;r+=this.BATCH_SIZE){let o=e.slice(r,r+this.BATCH_SIZE);await Promise.all(o.map(async e=>{try{let r=await t(e);s.set(e,r)}catch(t){console.error(`Error processing item ${e}:`,t),s.set(e,{})}})),r+this.BATCH_SIZE<e.length&&await new Promise(e=>setTimeout(e,this.DELAY_BETWEEN_BATCHES))}return s}}var n=s(55511),i=s.n(n);function a(e){return"object"==typeof e&&null!==e&&"statusCode"in e}class c{constructor(e){this.webflow=e,this.cache=r.getInstance(),this.rateLimiter=o.getInstance()}updateWebflowClient(e){this.webflow=e}async getRegisteredScripts(e){try{return(await this.webflow.scripts.list(e)).registeredScripts}catch(e){throw console.error("Error fetching scripts:",e),e}}async registerInlineScript(e,t){try{let s={sourceCode:t.sourceCode,canCopy:t.canCopy??!0,version:t.version,displayName:t.displayName};return await this.webflow.scripts.registerInline(e,s)}catch(e){throw console.error("Error registering inline script:",e),e}}async registerHostedScripts(e){try{console.log("Siteid in hosted script",e);let t="https://cdn.jsdelivr.net/gh/snm62/consentbit@08beb63/consentbit.js",s=await this.generateSRI(t),r={hostedLocation:t,integrityHash:s,canCopy:!0,version:"1.0.0",displayName:`Consent Script${Date.now()}`};return console.log("scriptData",r),await this.webflow.scripts.registerHosted(e,r)}catch(e){throw console.error("Error registering hosted script:",e),e}}async getSiteCustomCode(e){console.log("Using Access Token inside getSiteCustomCode:",this.webflow);let t=`site_${e}`;console.log(t);let s=this.cache.get(t);if(console.log(s),s)return s;try{console.log("inside try");let s=await this.webflow.sites.scripts.getCustomCode(e);return console.log("this is the result",s),this.cache.set(t,s),s}catch(e){throw console.error("Error fetching site custom code:",e),e}}async upsertSiteCustomCode(e,t,s,r){try{let o=await this.getExistingScripts("site",e);return console.log("[DEBUG] upsertSiteCustomCode existing scripts:",o),o=o.filter(e=>e.id!==t),console.log("[DEBUG] upsertSiteCustomCode after filter:",o),o.push({id:t,location:s,version:r}),console.log("[DEBUG] upsertSiteCustomCode final scripts array:",o),await this.webflow.sites.scripts.upsertCustomCode(e,{scripts:o})}catch(e){throw console.error("Error upserting site custom code:",e),e}}async deleteSiteCustomCode(e){try{let t=await this.webflow.sites.scripts.deleteCustomCode(e);return this.cache.set(`site_${e}`,null),t}catch(e){throw console.error("Error deleting site custom code:",e),e}}async getPageCustomCode(e){let t=`page_${e}`,s=this.cache.get(t);if(s)return s;try{let s=(await this.webflow.pages.scripts.getCustomCode(e)).scripts||[];return this.cache.set(t,s),s}catch(e){if(a(e)&&404!==e.statusCode)throw e;return[]}}async getMultiplePageCustomCode(e){let t=new Map,s=[];for(let r of e){let e=`page_${r}`,o=this.cache.get(e);o?t.set(r,o):s.push(r)}if(s.length>0)for(let[e,r]of(await this.rateLimiter.processBatch(s,async e=>{try{let t=(await this.webflow.pages.scripts.getCustomCode(e)).scripts||[];return this.cache.set(`page_${e}`,t),t}catch(e){if(a(e)&&404!==e.statusCode)throw e;return[]}})))t.set(e,r);return t}async upsertPageCustomCode(e,t,s,r){try{let o=await this.getExistingScripts("page",e);return(o=o.filter(e=>e.id!==t)).push({id:t,location:s,version:r}),await this.webflow.pages.scripts.upsertCustomCode(e,{scripts:o})}catch(e){throw console.error("Error upserting page custom code:",e),e}}async deletePageCustomCode(e){try{let t=await this.webflow.pages.scripts.deleteCustomCode(e);return this.cache.set(`page_${e}`,null),t}catch(e){throw console.error("Error deleting page custom code:",e),e}}async generateSRI(e){let t=await fetch(e),s=await t.text(),r=i().createHash("sha384").update(s).digest("base64");return`sha384-${r}`}async getExistingScripts(e,t){try{let s="site"===e?this.getSiteCustomCode:this.getPageCustomCode,r=await s.call(this,t);console.log(`[DEBUG] getExistingScripts raw response for ${e}:`,r);let o="site"===e?r.scripts||[]:r||[];return console.log(`[DEBUG] getExistingScripts processed scripts for ${e}:`,o),o}catch(t){if(console.error(`[DEBUG] getExistingScripts error for ${e}:`,t),a(t)&&404!==t.statusCode)throw t;return[]}}}},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[297,190,563],()=>s(41600));module.exports=r})();