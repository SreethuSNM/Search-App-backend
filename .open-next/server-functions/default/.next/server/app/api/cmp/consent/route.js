(()=>{var e={};e.id=701,e.ids=[701],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},57075:(e,t,r)=>{"use strict";r.d(t,{n:()=>a});var n=r(77412),o=r(97130);async function a(e,t){try{let r;if(console.log("inside verify visitor token",e),!e)return console.log("inside verify visitor token : no token"),{isValid:!1,error:"No token provided"};let[a]=e.split(".");if(!a)return{isValid:!1,error:"Invalid token format"};try{r=JSON.parse(atob(a))}catch(e){return console.error("Failed to decode token payload:",e),{isValid:!1,error:"Invalid token format"}}console.log("payload",r),console.log("inside verify visitor token: sitename",t);let i=await (0,o.A)(t);if(console.log("inside verify visitor token: sitedetails",i),!i)return{isValid:!1,error:"Site not found"};let{payload:s}=await (0,n.V)(e,new TextEncoder().encode(i.accessToken));if(s.exp&&s.exp<Math.floor(Date.now()/1e3))return{isValid:!1,error:"Token expired"};return{isValid:!0,payload:s,visitorId:s.visitorId,siteName:s.siteName}}catch(e){return console.error("Token verification failed:",e),{isValid:!1,error:"Invalid token"}}}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},77412:(e,t,r)=>{"use strict";r.d(t,{V:()=>S});var n=r(21187),o=r(16263),a=r(92120),i=r(4208);let s=async(e,t,r,n)=>{let s=await (0,i.A)(e,t,"verify");(0,a.A)(e,s);let c=(0,o.A)(e,s.algorithm);try{return await crypto.subtle.verify(c,s,r,n)}catch{return!1}};var c=r(70803),d=r(97989),l=r(74996),p=r(89531),y=r(44032),u=r(41286);let f=(e,t)=>{if(void 0!==t&&(!Array.isArray(t)||t.some(e=>"string"!=typeof e)))throw TypeError(`"${e}" option must be an array of strings`);if(t)return new Set(t)};var w=r(95548);async function g(e,t,r){let o,a;if(!(0,p.A)(e))throw new c.Ye("Flattened JWS must be an object");if(void 0===e.protected&&void 0===e.header)throw new c.Ye('Flattened JWS must have either of the "protected" or "header" members');if(void 0!==e.protected&&"string"!=typeof e.protected)throw new c.Ye("JWS Protected Header incorrect type");if(void 0===e.payload)throw new c.Ye("JWS Payload missing");if("string"!=typeof e.signature)throw new c.Ye("JWS Signature missing or incorrect type");if(void 0!==e.header&&!(0,p.A)(e.header))throw new c.Ye("JWS Unprotected Header incorrect type");let i={};if(e.protected)try{let t=(0,n.D)(e.protected);i=JSON.parse(d.D0.decode(t))}catch{throw new c.Ye("JWS Protected Header is invalid")}if(!(0,l.A)(i,e.header))throw new c.Ye("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let g={...i,...e.header},h=(0,u.A)(c.Ye,new Map([["b64",!0]]),r?.crit,i,g),m=!0;if(h.has("b64")&&"boolean"!=typeof(m=i.b64))throw new c.Ye('The "b64" (base64url-encode payload) Header Parameter must be a boolean');let{alg:S}=g;if("string"!=typeof S||!S)throw new c.Ye('JWS "alg" (Algorithm) Header Parameter missing or invalid');let v=r&&f("algorithms",r.algorithms);if(v&&!v.has(S))throw new c.Rb('"alg" (Algorithm) Header Parameter value not allowed');if(m){if("string"!=typeof e.payload)throw new c.Ye("JWS Payload must be a string")}else if("string"!=typeof e.payload&&!(e.payload instanceof Uint8Array))throw new c.Ye("JWS Payload must be a string or an Uint8Array instance");let A=!1;"function"==typeof t&&(t=await t(i,e),A=!0),(0,y.A)(S,t,"verify");let k=(0,d.xW)(d.Rd.encode(e.protected??""),d.Rd.encode("."),"string"==typeof e.payload?d.Rd.encode(e.payload):e.payload);try{o=(0,n.D)(e.signature)}catch{throw new c.Ye("Failed to base64url decode the signature")}let T=await (0,w.A)(t,S);if(!await s(S,T,o,k))throw new c.h2;if(m)try{a=(0,n.D)(e.payload)}catch{throw new c.Ye("Failed to base64url decode the payload")}else a="string"==typeof e.payload?d.Rd.encode(e.payload):e.payload;let N={payload:a};return(void 0!==e.protected&&(N.protectedHeader=i),void 0!==e.header&&(N.unprotectedHeader=e.header),A)?{...N,key:T}:N}async function h(e,t,r){if(e instanceof Uint8Array&&(e=d.D0.decode(e)),"string"!=typeof e)throw new c.Ye("Compact JWS must be a string or Uint8Array");let{0:n,1:o,2:a,length:i}=e.split(".");if(3!==i)throw new c.Ye("Invalid Compact JWS");let s=await g({payload:o,protected:n,signature:a},t,r),l={payload:s.payload,protectedHeader:s.protectedHeader};return"function"==typeof t?{...l,key:s.key}:l}var m=r(91492);async function S(e,t,r){let n=await h(e,t,r);if(n.protectedHeader.crit?.includes("b64")&&!1===n.protectedHeader.b64)throw new c.Dp("JWTs MUST NOT use unencoded payload");let o={payload:(0,m.k)(n.protectedHeader,n.payload,r),protectedHeader:n.protectedHeader};return"function"==typeof t?{...o,key:n.key}:o}},78335:()=>{},86390:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>T,routeModule:()=>S,serverHooks:()=>k,workAsyncStorage:()=>v,workUnitAsyncStorage:()=>A});var n={};r.r(n),r.d(n,{OPTIONS:()=>y,POST:()=>u});var o=r(96559),a=r(48088),i=r(37719),s=r(32190),c=r(6426),d=r(57075),l=r(97130);function p(e){let t=new Headers(e.headers);return t.set("Access-Control-Allow-Origin","*"),t.set("Access-Control-Allow-Methods","GET, POST, OPTIONS"),t.set("Access-Control-Allow-Headers","Content-Type, Authorization, X-Requested-With, Accept, Origin, X-CSRF-Token"),t.set("Access-Control-Allow-Credentials","true"),t.set("Access-Control-Max-Age","86400"),t.set("Vary","Origin"),new Response(e.body,{status:e.status,statusText:e.statusText,headers:t})}async function y(){return p(new Response(null,{status:204}))}async function u(e){try{let t;let r=await e.json();console.log("INSIDE CONSENT SAVE POST REQUEST:",r);let{env:n}=await (0,c.DM)({async:!0}),o=e.headers.get("Authorization");if(!o||!o.startsWith("Bearer "))return p(s.NextResponse.json({error:"Unauthorized"},{status:401}));let a=o.split(" ")[1],i=r.clientId.startsWith("http")?r.clientId:`https://${r.clientId}`,y=new URL(i).hostname.replace(/^www\./,"").replace(/\.webflow\.io$/,"").replace(/\.(com|net|org|io|co|dev|xyz|info|studio)$/,""),{isValid:u,error:S}=await (0,d.n)(a,y);if(!u)return p(s.NextResponse.json({error:S||"Invalid site name"},{status:401}));if(!await (0,l.A)(y))return p(s.NextResponse.json({error:"Site details not found"},{status:404}));if(!r.encryptedVisitorId?.encryptionKey?.key||!r.encryptedVisitorId?.encryptionKey?.iv||!r.preferences?.encryptionKey?.key||!r.preferences?.encryptionKey?.iv)return f("Missing encryption key or IV in request");let v=await m(r.encryptedVisitorId.encryptedPreferences,await h(g(r.encryptedVisitorId.encryptionKey.key)),g(r.encryptedVisitorId.encryptionKey.iv));try{let e=await m(r.preferences.encryptedPreferences,await h(g(r.preferences.encryptionKey.key)),g(r.preferences.encryptionKey.iv));t=JSON.parse(e),console.log("Decrypted preferences:",t),console.log("Decrypted preferences:",t)}catch(e){return console.error("Error decrypting preferences:",e),f("Invalid preferences format")}if(!r.clientId||!v||!t)return f("Missing required fields");let A=e.headers.get("CF-Connecting-IP")||"unknown-ip",k=r.country||"unknown-country",T={clientId:r.clientId,visitorId:v,timestamp:new Date().toISOString(),metadata:{...r.metadata,ip:A},policyVersion:r.policyVersion,lastUpdated:new Date().toISOString(),preferences:{},cookies:r.cookies,bannerType:r.bannerType};if("GDPR"===r.bannerType){let e=t.gdpr||t;T.preferences={necessary:!0,marketing:!!(e.Marketing??e.marketing),personalization:!!(e.Personalization??e.personalization),analytics:!!(e.Analytics??e.analytics),lastUpdated:e.lastUpdated||r.timestamp,country:k,ip:A}}else if("CCPA"===r.bannerType){let e=t.ccpa||t;T.preferences={necessary:!0,doNotShare:!!(e.DoNotShare??e.doNotShare),doNotSell:!!(e.DoNotSell??e.doNotSell),limitUse:!!(e.LimitUse??e.limitUse),lastUpdated:e.lastUpdated||r.timestamp,country:k,ip:A}}let N=`Cookie-Preferences:${r.clientId}:${v}`;console.log("KV key to store:",N),console.log("---CONSENT DATA",T);try{await n.WEBFLOW_AUTHENTICATION.put(N,JSON.stringify(T))}catch(e){if(e instanceof Error)return w("Error saving to KV",e);return w("Unknown KV error",Error(String(e)))}let I=new Headers;return I.append("Set-Cookie",`visitor-id=${v}; Path=/; HttpOnly; Secure; SameSite=Lax`),I.append("Set-Cookie",`consent-preferences=${JSON.stringify({necessary:t.necessary,marketing:t.marketing,personalization:t.personalization,analytics:t.analytics,doNotShare:t.doNotShare||!1,country:k,ip:A})}; Path=/; Max-Age=31536000; Secure; SameSite=Strict`),new Response(JSON.stringify({message:"Consent data saved successfully",consentData:T}),{status:200,headers:I})}catch(e){if(e instanceof Error)return w("Error processing consent",e);return w("Unknown error occurred")}}function f(e){return p(s.NextResponse.json({error:"Bad Request",details:e},{status:400}))}function w(e,t){return console.error(e,t?.message),p(s.NextResponse.json({error:e,details:t?.message||"Internal Server Error"},{status:500}))}function g(e){let t=atob(e),r=new Uint8Array(t.length);for(let e=0;e<t.length;e++)r[e]=t.charCodeAt(e);return r}async function h(e){return crypto.subtle.importKey("raw",e,{name:"AES-GCM"},!1,["encrypt","decrypt"])}async function m(e,t,r){let n=g(e),o=await crypto.subtle.decrypt({name:"AES-GCM",iv:r},t,n);return new TextDecoder().decode(o)}let S=new o.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/cmp/consent/route",pathname:"/api/cmp/consent",filename:"route",bundlePath:"app/api/cmp/consent/route"},resolvedPagePath:"C:\\Seattle\\Cookie App\\Consernbit-Cloudflare-Server-Test\\cb-server\\app\\api\\cmp\\consent\\route.ts",nextConfigOutput:"standalone",userland:n}),{workAsyncStorage:v,workUnitAsyncStorage:A,serverHooks:k}=S;function T(){return(0,i.patchFetch)({workAsyncStorage:v,workUnitAsyncStorage:A})}},96487:()=>{},97130:(e,t,r)=>{"use strict";r.d(t,{A:()=>o});var n=r(6426);async function o(e){try{let{env:t}=await (0,n.DM)({async:!0});if(!t?.WEBFLOW_AUTHENTICATION)return console.error("KV binding missing"),null;let r=await t.WEBFLOW_AUTHENTICATION.list();for(let n of(console.log("siteName",e),console.log("ev keys",r),r.keys)){let r=await t.WEBFLOW_AUTHENTICATION.get(n.name);if(r){let t=JSON.parse(r);if(t.siteName===e)return{...t,siteId:n.name}}}return null}catch(e){return console.error("Error finding site details:",e),null}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[297,190,699],()=>r(86390));module.exports=n})();