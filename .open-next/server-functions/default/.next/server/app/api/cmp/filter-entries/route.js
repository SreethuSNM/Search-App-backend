(()=>{var e={};e.id=128,e.ids=[128],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},57075:(e,t,r)=>{"use strict";r.d(t,{n:()=>n});var o=r(77412),a=r(97130);async function n(e,t){try{let r;if(console.log("inside verify visitor token",e),!e)return console.log("inside verify visitor token : no token"),{isValid:!1,error:"No token provided"};let[n]=e.split(".");if(!n)return{isValid:!1,error:"Invalid token format"};try{r=JSON.parse(atob(n))}catch(e){return console.error("Failed to decode token payload:",e),{isValid:!1,error:"Invalid token format"}}console.log("payload",r),console.log("inside verify visitor token: sitename",t);let i=await (0,a.A)(t);if(console.log("inside verify visitor token: sitedetails",i),!i)return{isValid:!1,error:"Site not found"};let{payload:s}=await (0,o.V)(e,new TextEncoder().encode(i.accessToken));if(s.exp&&s.exp<Math.floor(Date.now()/1e3))return{isValid:!1,error:"Token expired"};return{isValid:!0,payload:s,visitorId:s.visitorId,siteName:s.siteName}}catch(e){return console.error("Token verification failed:",e),{isValid:!1,error:"Invalid token"}}}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66260:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>v,routeModule:()=>h,serverHooks:()=>m,workAsyncStorage:()=>w,workUnitAsyncStorage:()=>g});var o={};r.r(o),r.d(o,{OPTIONS:()=>u,POST:()=>f});var a=r(96559),n=r(48088),i=r(37719),s=r(32190),l=r(6426),d=r(97130),c=r(57075);function p(e){return e.headers.set("Access-Control-Allow-Origin","*"),e.headers.set("Access-Control-Allow-Methods","GET, POST, OPTIONS"),e.headers.set("Access-Control-Allow-Headers","Content-Type, Authorization"),e}async function u(){return p(new s.NextResponse(null,{status:204}))}async function y(e){let t=null,r=[],o=0,{env:a}=await (0,l.DM)({async:!0});do{console.log("Fetching page:",o+1);let n=await a.CMP_MANUAL.list({cursor:t,limit:100});for(let o of(t=n.cursor||null,console.log("Entries in current page:",n.keys.length),n.keys))try{let t=await a.WEBFLOW_AUTHENTICATION.get(o.name);if(t){let a=JSON.parse(t);a.siteId===e&&(a.cookies||(a.cookies={necessary:[],marketing:[],personalization:[],analytics:[],other:[]}),r.push(a),console.log("Found matching entry:",o.name))}}catch(e){console.error("Error processing entry:",o.name,e)}o++,console.log("Total matching entries so far:",r.length)}while(t&&o<10);return console.log("Total pages processed:",o),console.log("Final number of entries:",r.length),r}async function f(e){try{let t=e.headers.get("Authorization");if(!t||!t.startsWith("Bearer "))return p(s.NextResponse.json({error:"Unauthorized"},{status:401}));let r="sitename",o=t.split(" ")[1],{isValid:a,error:n}=await (0,c.n)(o,r);if(!a||!r)return p(s.NextResponse.json({error:n||"Invalid site name"},{status:401}));let i=await (0,d.A)(r);if(!i)return p(s.NextResponse.json({error:"Site details not found"},{status:404}));let l=await y(i.siteId);console.log("Total entries retrieved:",l.length);let u={title:"Filtered Consent Entries",entries:l.map((e,t)=>({entryNumber:t+1,siteId:e.siteId,visitorId:e.visitorId,preferences:e.preferences,metadata:e.metadata||{},timestamp:e.timestamp||e.lastUpdated,cookies:e.cookies||{necessary:[],marketing:[],personalization:[],analytics:[],other:[]}}))};return p(s.NextResponse.json(u))}catch(e){if(e instanceof Error)return console.error("Error applying custom code:",e.message),p(s.NextResponse.json({error:"Failed to apply custom code",details:e.message},{status:500}));return console.error("Unknown error:",e),p(s.NextResponse.json({error:"Failed to apply custom code",details:"An unknown error occurred"},{status:500}))}}let h=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/cmp/filter-entries/route",pathname:"/api/cmp/filter-entries",filename:"route",bundlePath:"app/api/cmp/filter-entries/route"},resolvedPagePath:"C:\\Seattle\\Cookie App\\Consernbit-Cloudflare-Server-Test\\cb-server\\app\\api\\cmp\\filter-entries\\route.ts",nextConfigOutput:"standalone",userland:o}),{workAsyncStorage:w,workUnitAsyncStorage:g,serverHooks:m}=h;function v(){return(0,i.patchFetch)({workAsyncStorage:w,workUnitAsyncStorage:g})}},77412:(e,t,r)=>{"use strict";r.d(t,{V:()=>v});var o=r(21187),a=r(16263),n=r(92120),i=r(4208);let s=async(e,t,r,o)=>{let s=await (0,i.A)(e,t,"verify");(0,n.A)(e,s);let l=(0,a.A)(e,s.algorithm);try{return await crypto.subtle.verify(l,s,r,o)}catch{return!1}};var l=r(70803),d=r(97989),c=r(74996),p=r(89531),u=r(44032),y=r(41286);let f=(e,t)=>{if(void 0!==t&&(!Array.isArray(t)||t.some(e=>"string"!=typeof e)))throw TypeError(`"${e}" option must be an array of strings`);if(t)return new Set(t)};var h=r(95548);async function w(e,t,r){let a,n;if(!(0,p.A)(e))throw new l.Ye("Flattened JWS must be an object");if(void 0===e.protected&&void 0===e.header)throw new l.Ye('Flattened JWS must have either of the "protected" or "header" members');if(void 0!==e.protected&&"string"!=typeof e.protected)throw new l.Ye("JWS Protected Header incorrect type");if(void 0===e.payload)throw new l.Ye("JWS Payload missing");if("string"!=typeof e.signature)throw new l.Ye("JWS Signature missing or incorrect type");if(void 0!==e.header&&!(0,p.A)(e.header))throw new l.Ye("JWS Unprotected Header incorrect type");let i={};if(e.protected)try{let t=(0,o.D)(e.protected);i=JSON.parse(d.D0.decode(t))}catch{throw new l.Ye("JWS Protected Header is invalid")}if(!(0,c.A)(i,e.header))throw new l.Ye("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let w={...i,...e.header},g=(0,y.A)(l.Ye,new Map([["b64",!0]]),r?.crit,i,w),m=!0;if(g.has("b64")&&"boolean"!=typeof(m=i.b64))throw new l.Ye('The "b64" (base64url-encode payload) Header Parameter must be a boolean');let{alg:v}=w;if("string"!=typeof v||!v)throw new l.Ye('JWS "alg" (Algorithm) Header Parameter missing or invalid');let A=r&&f("algorithms",r.algorithms);if(A&&!A.has(v))throw new l.Rb('"alg" (Algorithm) Header Parameter value not allowed');if(m){if("string"!=typeof e.payload)throw new l.Ye("JWS Payload must be a string")}else if("string"!=typeof e.payload&&!(e.payload instanceof Uint8Array))throw new l.Ye("JWS Payload must be a string or an Uint8Array instance");let k=!1;"function"==typeof t&&(t=await t(i,e),k=!0),(0,u.A)(v,t,"verify");let T=(0,d.xW)(d.Rd.encode(e.protected??""),d.Rd.encode("."),"string"==typeof e.payload?d.Rd.encode(e.payload):e.payload);try{a=(0,o.D)(e.signature)}catch{throw new l.Ye("Failed to base64url decode the signature")}let S=await (0,h.A)(t,v);if(!await s(v,S,a,T))throw new l.h2;if(m)try{n=(0,o.D)(e.payload)}catch{throw new l.Ye("Failed to base64url decode the payload")}else n="string"==typeof e.payload?d.Rd.encode(e.payload):e.payload;let b={payload:n};return(void 0!==e.protected&&(b.protectedHeader=i),void 0!==e.header&&(b.unprotectedHeader=e.header),k)?{...b,key:S}:b}async function g(e,t,r){if(e instanceof Uint8Array&&(e=d.D0.decode(e)),"string"!=typeof e)throw new l.Ye("Compact JWS must be a string or Uint8Array");let{0:o,1:a,2:n,length:i}=e.split(".");if(3!==i)throw new l.Ye("Invalid Compact JWS");let s=await w({payload:a,protected:o,signature:n},t,r),c={payload:s.payload,protectedHeader:s.protectedHeader};return"function"==typeof t?{...c,key:s.key}:c}var m=r(91492);async function v(e,t,r){let o=await g(e,t,r);if(o.protectedHeader.crit?.includes("b64")&&!1===o.protectedHeader.b64)throw new l.Dp("JWTs MUST NOT use unencoded payload");let a={payload:(0,m.k)(o.protectedHeader,o.payload,r),protectedHeader:o.protectedHeader};return"function"==typeof t?{...a,key:o.key}:a}},78335:()=>{},96487:()=>{},97130:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});var o=r(6426);async function a(e){try{let{env:t}=await (0,o.DM)({async:!0});if(!t?.WEBFLOW_AUTHENTICATION)return console.error("KV binding missing"),null;let r=await t.WEBFLOW_AUTHENTICATION.list();for(let o of(console.log("siteName",e),console.log("ev keys",r),r.keys)){let r=await t.WEBFLOW_AUTHENTICATION.get(o.name);if(r){let t=JSON.parse(r);if(t.siteName===e)return{...t,siteId:o.name}}}return null}catch(e){return console.error("Error finding site details:",e),null}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[297,190,699],()=>r(66260));module.exports=o})();