(()=>{var e={};e.id=128,e.ids=[128],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46509:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});var s=r(87806),n=r(77412),o=r(6426);let a={createSessionToken:async e=>{let t=new TextEncoder().encode(process.env.CLIENT_SECRET),r=await new s.P({user:e}).setProtectedHeader({alg:"HS256"}).setExpirationTime("24h").sign(t),o=await (0,n.V)(r,t);return console.log("____inside create session_____ ",r),{sessionToken:r,exp:o.payload.exp}},verifyAuth:async e=>{let t=e.headers.get("authorization"),r=t?.split(" ")[1];if(console.log("inside verify auth session",r),!r)return null;try{let e=new TextEncoder().encode(process.env.WEBFLOW_CLIENT_SECRET),{payload:t}=await (0,n.V)(r,e),s=t.user.id,{env:a}=await (0,o.DM)({async:!0}),i=await a.WEBFLOW_AUTHENTICATION.get(`user-auth:${s}`);if(i){let e=JSON.parse(i);return console.log("inside verify auth access token",e.accessToken),e.accessToken}return null}catch{return null}},getAccessToken:async e=>{try{let t=null;if("POST"===e.method?(t=(await e.json()).siteId,console.log("siteId",t)):"GET"===e.method&&(t=e.nextUrl.searchParams.get("siteId"),console.log("siteId in params",t)),!t)return console.error("No siteId provided in request."),null;let{env:r}=await (0,o.DM)({async:!0}),s=await r.WEBFLOW_AUTHENTICATION.get(t);if(console.log("stored info in kv",s),s)return JSON.parse(s).accessToken;return console.error(`No access token found for site ${t}`),null}catch(e){return console.error("Error getting access token:",e),null}},getSiteIdFromAccessToken:async e=>{try{let{env:t}=await (0,o.DM)({async:!0});for(let r of(await t.WEBFLOW_AUTHENTICATION.list()).keys){let s=await t.WEBFLOW_AUTHENTICATION.get(r.name);if(s&&JSON.parse(s).accessToken===e)return String(r.name)}return null}catch(e){return console.error("Error getting site ID:",e),null}}}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},66260:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>T,routeModule:()=>m,serverHooks:()=>y,workAsyncStorage:()=>f,workUnitAsyncStorage:()=>h});var s={};r.r(s),r.d(s,{OPTIONS:()=>d,POST:()=>g});var n=r(96559),o=r(48088),a=r(37719),i=r(32190),l=r(46509),c=r(6426);function u(e){return e.headers.set("Access-Control-Allow-Origin","*"),e.headers.set("Access-Control-Allow-Methods","GET, POST, OPTIONS"),e.headers.set("Access-Control-Allow-Headers","Content-Type, Authorization"),e}async function d(){return u(new i.NextResponse(null,{status:204}))}async function p(e){let t=null,r=[],s=0,{env:n}=await (0,c.DM)({async:!0});do{console.log("Fetching page:",s+1);let o=await n.CMP_MANUAL.list({cursor:t,limit:100});for(let s of(t=o.cursor||null,console.log("Entries in current page:",o.keys.length),o.keys))try{let t=await n.CMP_MANUAL.get(s.name);if(t){let n=JSON.parse(t);n.siteId===e&&(n.cookies||(n.cookies={necessary:[],marketing:[],personalization:[],analytics:[],other:[]}),r.push(n),console.log("Found matching entry:",s.name))}}catch(e){console.error("Error processing entry:",s.name,e)}s++,console.log("Total matching entries so far:",r.length)}while(t&&s<10);return console.log("Total pages processed:",s),console.log("Final number of entries:",r.length),r}async function g(e){try{let t=await l.A.verifyAuth(e);if(!t)return console.error("Authentication failed:",t),u(i.NextResponse.json({error:"Unauthorized",details:t||"Authentication failed"},{status:401}));let r=await l.A.getSiteIdFromAccessToken(t);if(!r)return console.error("SiteId not found:",r),u(i.NextResponse.json({error:"Unauthorized",details:r||"SiteId failed"},{status:401}));let s=await p(r);console.log("Total entries retrieved:",s.length);let n={title:"Filtered Consent Entries",entries:s.map((e,t)=>({entryNumber:t+1,siteId:e.siteId,visitorId:e.visitorId,preferences:e.preferences,metadata:e.metadata||{},timestamp:e.timestamp||e.lastUpdated,cookies:e.cookies||{necessary:[],marketing:[],personalization:[],analytics:[],other:[]}}))};return u(i.NextResponse.json(n))}catch(e){if(e instanceof Error)return console.error("Error applying custom code:",e.message),u(i.NextResponse.json({error:"Failed to apply custom code",details:e.message},{status:500}));return console.error("Unknown error:",e),u(i.NextResponse.json({error:"Failed to apply custom code",details:"An unknown error occurred"},{status:500}))}}let m=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/cmp/filter-entries/route",pathname:"/api/cmp/filter-entries",filename:"route",bundlePath:"app/api/cmp/filter-entries/route"},resolvedPagePath:"C:\\Seattle\\Cookie App\\Consernbit-Cloudflare-Server-Test\\cb-server\\app\\api\\cmp\\filter-entries\\route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:f,workUnitAsyncStorage:h,serverHooks:y}=m;function T(){return(0,a.patchFetch)({workAsyncStorage:f,workUnitAsyncStorage:h})}},78335:()=>{},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[297,190,682],()=>r(66260));module.exports=s})();