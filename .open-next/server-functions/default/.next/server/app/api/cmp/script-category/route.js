(()=>{var e={};e.id=353,e.ids=[353],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},50228:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>m,routeModule:()=>h,serverHooks:()=>A,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>v});var o={};r.r(o),r.d(o,{OPTIONS:()=>f,POST:()=>w});var i=r(96559),a=r(48088),n=r(37719),s=r(32190),d=r(6426),l=r(57075),c=r(97130);let p=["https://consentbits-stellar-site.webflow.io","https://*.webflow.io","http://localhost:3000"];function u(e,t){let r=new Headers(e.headers),o=t&&p.some(e=>e.includes("*")?t.endsWith(e.replace("*","")):e===t)?t:p[0];return r.set("Access-Control-Allow-Origin",o),r.set("Access-Control-Allow-Methods","GET, POST, OPTIONS"),r.set("Access-Control-Allow-Headers","Content-Type, Authorization, X-Requested-With, Accept, Origin, X-CSRF-Token, X-Request-ID"),r.set("Access-Control-Allow-Credentials","true"),r.set("Access-Control-Max-Age","86400"),r.set("Vary","Origin"),new s.NextResponse(e.body,{status:e.status,statusText:e.statusText,headers:r})}function y(e,t,r){return u(new s.NextResponse(JSON.stringify({error:e}),{status:t}),r)}async function f(e){let t=e.headers.get("origin"),r=t&&p.some(e=>e.includes("*")?t.endsWith(e.replace("*","")):e===t)?t:p[0];return new s.NextResponse(null,{status:204,headers:{"Access-Control-Allow-Origin":r,"Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization, X-Requested-With, Accept, Origin, X-CSRF-Token, X-Request-ID","Access-Control-Allow-Credentials":"true","Access-Control-Max-Age":"86400",Vary:"Origin"}})}async function w(e){let t=e.headers.get("origin");try{let r=e.headers.get("Authorization");if(!r||!r.startsWith("Bearer "))return y("Unauthorized",401,t);let o=r.split(" ")[1],{siteName:i,visitorId:a}=await e.json();if(console.log("SITE NAME :",i),!i)return y("Site name is required",400,t);try{let{isValid:e,error:r}=await (0,l.n)(o,i);if(!e)return y(r||"Invalid token or site name",401,t)}catch(e){return console.error("Token verification failed:",e),y("Token verification failed",401,t)}let n=await (0,c.A)(i);if(!n)return y("Site details not found",404,t);let p=await (0,d.DM)();if(!p?.env?.WEBFLOW_AUTHENTICATION)return console.error("KV binding missing or misconfigured"),y("Internal server error: KV binding missing",500,t);let f=`script-categories:${n.siteId}`,w=await p.env.WEBFLOW_AUTHENTICATION.get(f);if(!w)return u(new s.NextResponse(JSON.stringify({scripts:[],message:"No script categories found for this site"}),{status:200}),t);try{let e=JSON.parse(w);return u(new s.NextResponse(JSON.stringify({scripts:e,visitorId:a}),{status:200}),t)}catch(e){return console.error("Failed to parse script data:",e,w),u(new s.NextResponse(JSON.stringify({scripts:[],message:"Error parsing script categories"}),{status:500}),t)}}catch(e){return console.error("Unexpected error in POST handler:",e),y("Internal server error",500,t)}}let h=new i.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/cmp/script-category/route",pathname:"/api/cmp/script-category",filename:"route",bundlePath:"app/api/cmp/script-category/route"},resolvedPagePath:"C:\\Seattle\\Cookie App\\Consernbit-Cloudflare-Server-Test\\cb-server\\app\\api\\cmp\\script-category\\route.ts",nextConfigOutput:"standalone",userland:o}),{workAsyncStorage:g,workUnitAsyncStorage:v,serverHooks:A}=h;function m(){return(0,n.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:v})}},57075:(e,t,r)=>{"use strict";r.d(t,{n:()=>a});var o=r(77412),i=r(97130);async function a(e,t){try{let r;if(console.log("inside verify visitor token",e),!e)return console.log("inside verify visitor token : no token"),{isValid:!1,error:"No token provided"};let[a]=e.split(".");if(!a)return{isValid:!1,error:"Invalid token format"};try{r=JSON.parse(atob(a))}catch(e){return console.error("Failed to decode token payload:",e),{isValid:!1,error:"Invalid token format"}}console.log("payload",r),console.log("inside verify visitor token: sitename",t);let n=await (0,i.A)(t);if(console.log("inside verify visitor token: sitedetails",n),!n)return{isValid:!1,error:"Site not found"};let{payload:s}=await (0,o.V)(e,new TextEncoder().encode(n.accessToken));if(s.exp&&s.exp<Math.floor(Date.now()/1e3))return{isValid:!1,error:"Token expired"};return{isValid:!0,payload:s,visitorId:s.visitorId,siteName:s.siteName}}catch(e){return console.error("Token verification failed:",e),{isValid:!1,error:"Invalid token"}}}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},77412:(e,t,r)=>{"use strict";r.d(t,{V:()=>A});var o=r(21187),i=r(16263),a=r(92120),n=r(4208);let s=async(e,t,r,o)=>{let s=await (0,n.A)(e,t,"verify");(0,a.A)(e,s);let d=(0,i.A)(e,s.algorithm);try{return await crypto.subtle.verify(d,s,r,o)}catch{return!1}};var d=r(70803),l=r(97989),c=r(74996),p=r(89531),u=r(44032),y=r(41286);let f=(e,t)=>{if(void 0!==t&&(!Array.isArray(t)||t.some(e=>"string"!=typeof e)))throw TypeError(`"${e}" option must be an array of strings`);if(t)return new Set(t)};var w=r(95548);async function h(e,t,r){let i,a;if(!(0,p.A)(e))throw new d.Ye("Flattened JWS must be an object");if(void 0===e.protected&&void 0===e.header)throw new d.Ye('Flattened JWS must have either of the "protected" or "header" members');if(void 0!==e.protected&&"string"!=typeof e.protected)throw new d.Ye("JWS Protected Header incorrect type");if(void 0===e.payload)throw new d.Ye("JWS Payload missing");if("string"!=typeof e.signature)throw new d.Ye("JWS Signature missing or incorrect type");if(void 0!==e.header&&!(0,p.A)(e.header))throw new d.Ye("JWS Unprotected Header incorrect type");let n={};if(e.protected)try{let t=(0,o.D)(e.protected);n=JSON.parse(l.D0.decode(t))}catch{throw new d.Ye("JWS Protected Header is invalid")}if(!(0,c.A)(n,e.header))throw new d.Ye("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let h={...n,...e.header},g=(0,y.A)(d.Ye,new Map([["b64",!0]]),r?.crit,n,h),v=!0;if(g.has("b64")&&"boolean"!=typeof(v=n.b64))throw new d.Ye('The "b64" (base64url-encode payload) Header Parameter must be a boolean');let{alg:A}=h;if("string"!=typeof A||!A)throw new d.Ye('JWS "alg" (Algorithm) Header Parameter missing or invalid');let m=r&&f("algorithms",r.algorithms);if(m&&!m.has(A))throw new d.Rb('"alg" (Algorithm) Header Parameter value not allowed');if(v){if("string"!=typeof e.payload)throw new d.Ye("JWS Payload must be a string")}else if("string"!=typeof e.payload&&!(e.payload instanceof Uint8Array))throw new d.Ye("JWS Payload must be a string or an Uint8Array instance");let S=!1;"function"==typeof t&&(t=await t(n,e),S=!0),(0,u.A)(A,t,"verify");let T=(0,l.xW)(l.Rd.encode(e.protected??""),l.Rd.encode("."),"string"==typeof e.payload?l.Rd.encode(e.payload):e.payload);try{i=(0,o.D)(e.signature)}catch{throw new d.Ye("Failed to base64url decode the signature")}let O=await (0,w.A)(t,A);if(!await s(A,O,i,T))throw new d.h2;if(v)try{a=(0,o.D)(e.payload)}catch{throw new d.Ye("Failed to base64url decode the payload")}else a="string"==typeof e.payload?l.Rd.encode(e.payload):e.payload;let k={payload:a};return(void 0!==e.protected&&(k.protectedHeader=n),void 0!==e.header&&(k.unprotectedHeader=e.header),S)?{...k,key:O}:k}async function g(e,t,r){if(e instanceof Uint8Array&&(e=l.D0.decode(e)),"string"!=typeof e)throw new d.Ye("Compact JWS must be a string or Uint8Array");let{0:o,1:i,2:a,length:n}=e.split(".");if(3!==n)throw new d.Ye("Invalid Compact JWS");let s=await h({payload:i,protected:o,signature:a},t,r),c={payload:s.payload,protectedHeader:s.protectedHeader};return"function"==typeof t?{...c,key:s.key}:c}var v=r(91492);async function A(e,t,r){let o=await g(e,t,r);if(o.protectedHeader.crit?.includes("b64")&&!1===o.protectedHeader.b64)throw new d.Dp("JWTs MUST NOT use unencoded payload");let i={payload:(0,v.k)(o.protectedHeader,o.payload,r),protectedHeader:o.protectedHeader};return"function"==typeof t?{...i,key:o.key}:i}},78335:()=>{},96487:()=>{},97130:(e,t,r)=>{"use strict";r.d(t,{A:()=>i});var o=r(6426);async function i(e){try{let{env:t}=await (0,o.DM)({async:!0});for(let r of(await t.WEBFLOW_AUTHENTICATION.list()).keys){let o=await t.WEBFLOW_AUTHENTICATION.get(r.name);if(o){let t=JSON.parse(o);if(t.siteName===e)return{...t,siteId:r.name}}}return null}catch(e){return console.error("Error finding site details:",e),null}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[297,190,699],()=>r(50228));module.exports=o})();