(()=>{var e={};e.id=353,e.ids=[353],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12472:(e,t,r)=>{"use strict";r.d(t,{E:()=>o});var s=r(55511),n=r.n(s);class o{static{this.SENSITIVE_FIELDS=["script","apiKey","secret","password","token"]}static sanitizeScript(e){let t={url:e.url,category:e.category,name:e.name,id:this.generateScriptId(e)};return this.SENSITIVE_FIELDS.forEach(e=>{e in t&&delete t[e]}),t}static generateScriptId(e){let t=`${e.url||""}${e.name||""}${e.category||""}`;return n().createHash("sha256").update(t).digest("hex")}static validateScript(e){if(!e)return!1;if(e.url)try{new URL(e.url)}catch{return!1}return(!e.category||"string"==typeof e.category)&&(!e.name||"string"==typeof e.name)}static sanitizeScripts(e){return e.filter(e=>this.validateScript(e)).map(e=>this.sanitizeScript(e))}static addSecurityHeaders(e){e.set("X-Content-Type-Options","nosniff"),e.set("X-Frame-Options","DENY"),e.set("X-XSS-Protection","1; mode=block"),e.set("Content-Security-Policy","default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"),e.set("Referrer-Policy","strict-origin-when-cross-origin")}}},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46509:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});var s=r(87806),n=r(77412),o=r(6426);let a={createSessionToken:async e=>{let t=new TextEncoder().encode(process.env.CLIENT_SECRET),r=await new s.P({user:e}).setProtectedHeader({alg:"HS256"}).setExpirationTime("24h").sign(t),o=await (0,n.V)(r,t);return console.log("____inside create session_____ ",r),{sessionToken:r,exp:o.payload.exp}},verifyAuth:async e=>{let t=e.headers.get("authorization"),r=t?.split(" ")[1];if(console.log("inside verify auth session",r),!r)return null;try{let e=new TextEncoder().encode(process.env.WEBFLOW_CLIENT_SECRET),{payload:t}=await (0,n.V)(r,e),s=t.user.id,{env:a}=await (0,o.DM)({async:!0}),i=await a.WEBFLOW_AUTHENTICATION.get(`user-auth:${s}`);if(i){let e=JSON.parse(i);return console.log("inside verify auth access token",e.accessToken),e.accessToken}return null}catch{return null}},getAccessToken:async e=>{try{let t=null;if("POST"===e.method?(t=(await e.json()).siteId,console.log("siteId",t)):"GET"===e.method&&(t=e.nextUrl.searchParams.get("siteId"),console.log("siteId in params",t)),!t)return console.error("No siteId provided in request."),null;let{env:r}=await (0,o.DM)({async:!0}),s=await r.WEBFLOW_AUTHENTICATION.get(t);if(console.log("stored info in kv",s),s)return JSON.parse(s).accessToken;return console.error(`No access token found for site ${t}`),null}catch(e){return console.error("Error getting access token:",e),null}},getSiteIdFromAccessToken:async e=>{try{let{env:t}=await (0,o.DM)({async:!0});for(let r of(await t.WEBFLOW_AUTHENTICATION.list()).keys){let s=await t.WEBFLOW_AUTHENTICATION.get(r.name);if(s&&JSON.parse(s).accessToken===e)return String(r.name)}return null}catch(e){return console.error("Error getting site ID:",e),null}}}},50228:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>E,routeModule:()=>f,serverHooks:()=>T,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>h});var s={};r.r(s),r.d(s,{GET:()=>g,OPTIONS:()=>d});var n=r(96559),o=r(48088),a=r(37719),i=r(32190),c=r(6426),u=r(46509),l=r(12472);function p(e){return e.headers.set("Access-Control-Allow-Origin","*"),e.headers.set("Access-Control-Allow-Methods","GET, OPTIONS"),e.headers.set("Access-Control-Allow-Headers","Content-Type, Authorization, X-Request-ID"),l.E.addSecurityHeaders(e.headers),e}async function d(){return p(new i.NextResponse(null,{status:204}))}async function g(e){try{let t=e.headers.get("X-Request-ID");if(!t)return p(i.NextResponse.json({error:"Missing request ID"},{status:400}));let r=await u.A.verifyAuth(e);if(!r)return p(i.NextResponse.json({error:"Unauthorized"},{status:401}));let s=await u.A.getSiteIdFromAccessToken(r);if(!s)return p(i.NextResponse.json({error:"Unauthorized",details:"SiteId not found"},{status:401}));let{env:n}=(0,c.DM)();if(!n)return p(i.NextResponse.json({error:"Cloudflare environment not available"},{status:500}));let o=`script-categories:${s}`,a=await n.WEBFLOW_AUTHENTICATION.get(o);if(!a)return p(i.NextResponse.json({scripts:[],message:"No script categories found for this site"}));try{let e=JSON.parse(a),r=l.E.sanitizeScripts(e.scripts);return p(i.NextResponse.json({scripts:r,requestId:t,timestamp:new Date().toISOString()}))}catch(e){return console.error("Error parsing script data:",e),p(i.NextResponse.json({error:"Error parsing script categories"},{status:500}))}}catch(e){return console.error("Error fetching script categories:",e),p(i.NextResponse.json({error:"Internal server error"},{status:500}))}}let f=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/cmp/script-category/route",pathname:"/api/cmp/script-category",filename:"route",bundlePath:"app/api/cmp/script-category/route"},resolvedPagePath:"C:\\Seattle\\Cookie App\\Consernbit-Cloudflare-Server-Test\\cb-server\\app\\api\\cmp\\script-category\\route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:y,workUnitAsyncStorage:h,serverHooks:T}=f;function E(){return(0,a.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:h})}},55511:e=>{"use strict";e.exports=require("crypto")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[297,190,682],()=>r(50228));module.exports=s})();