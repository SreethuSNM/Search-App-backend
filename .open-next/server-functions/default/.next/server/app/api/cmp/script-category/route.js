(()=>{var e={};e.id=353,e.ids=[353],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},6426:(e,t,r)=>{"use strict";r.d(t,{DM:()=>o});let n=Symbol.for("__cloudflare-context__");function o(e={async:!1}){return e.async?s():function(){let e=i();if(e)return e;if(function(){let e=globalThis;return e.__NEXT_DATA__?.nextExport===!0}())throw Error("\n\nERROR: `getCloudflareContext` has been called in sync mode in either a static route or at the top level of a non-static one, both cases are not allowed but can be solved by either:\n  - make sure that the call is not at the top level and that the route is not static\n  - call `getCloudflareContext({async: true})` to use the `async` mode\n  - avoid calling `getCloudflareContext` in the route\n");throw Error(l)}()}function i(){return globalThis[n]}async function s(){let e=i();if(e)return e;{let e=await a();return function(e){globalThis[n]=e}(e),e}}async function a(){let{getPlatformProxy:e}=await import(`${"__wrangler".replaceAll("_","")}`),{env:t,cf:r,ctx:n}=await e({environment:process.env.NEXT_DEV_WRANGLER_ENV});return{env:t,cf:r,ctx:n}}let l='\n\nERROR: `getCloudflareContext` has been called without having called `initOpenNextCloudflareForDev` from the Next.js config file.\nYou should update your Next.js config file as shown below:\n\n   ```\n   // next.config.mjs\n\n   import { initOpenNextCloudflareForDev } from "@opennextjs/cloudflare";\n\n   initOpenNextCloudflareForDev();\n\n'+"   const nextConfig = { ... };\n   export default nextConfig;\n   ```\n\n"},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},21775:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>T,routeModule:()=>A,serverHooks:()=>m,workAsyncStorage:()=>w,workUnitAsyncStorage:()=>h});var n={};r.r(n),r.d(n,{OPTIONS:()=>f,POST:()=>g});var o=r(96559),i=r(48088),s=r(37719),a=r(32190),l=r(6426),c=r(94337);async function u(e,t){try{console.log(`Verifying token for site: ${t}`),console.log(`Token to verify: ${e}`);let r=await (0,l.DM)();if(!r?.env?.WEBFLOW_AUTHENTICATION)return console.error("KV binding missing"),{isValid:!1,error:"KV binding missing"};let n=`visitor-token:${t}`;console.log(`Looking up token with key: ${n}`);let o=await r.env.WEBFLOW_AUTHENTICATION.get(n);if(console.log(`Stored token: ${o?"Found":"Not found"}`),!o)return{isValid:!1,error:"No token found for site"};if(e!==o)return console.log(`Token mismatch. Expected: ${o}, Got: ${e}`),{isValid:!1,error:"Invalid token"};return console.log(`Token verified successfully for site: ${t}`),{isValid:!0}}catch(e){return console.error("Token verification error:",e),{isValid:!1,error:"Token verification failed"}}}var d=r(97130);function p(e){let t=new Headers(e.headers);return t.set("Access-Control-Allow-Origin","*"),t.set("Access-Control-Allow-Methods","GET, POST, OPTIONS"),t.set("Access-Control-Allow-Headers","Content-Type, Authorization, X-Requested-With, Accept, Origin, X-CSRF-Token, X-Request-ID"),t.set("Access-Control-Allow-Credentials","true"),t.set("Access-Control-Max-Age","86400"),t.set("Vary","Origin"),new a.NextResponse(e.body,{status:e.status,statusText:e.statusText,headers:t})}function y(e,t){return p(new a.NextResponse(JSON.stringify({error:e}),{status:t}))}async function f(){return new a.NextResponse(null,{status:204,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization, X-Requested-With, Accept, Origin, X-CSRF-Token, X-Request-ID","Access-Control-Allow-Credentials":"true","Access-Control-Max-Age":"86400",Vary:"Origin"}})}async function g(e){try{let t=e.headers.get("Authorization");if(!t||!t.startsWith("Bearer "))return y("Unauthorized",401);let r=t.split(" ")[1],{encryptedData:n,key:o,iv:i}=await e.json();if(!n||!o||!i)return y("Missing encrypted data or encryption parameters",400);let s=new Uint8Array(o),f=new Uint8Array(i),g=await c.X.importKey(s,["decrypt"]),A=await c.X.decrypt(n,g,f),{siteName:w,visitorId:h}=JSON.parse(A);if(!w)return y("Site name is required",400);try{let{isValid:e,error:t}=await u(r,w);if(!e)return y(t||"Invalid token or site name",401)}catch(e){return console.error("Token verification failed:",e),y("Token verification failed",401)}let m=await (0,d.A)(w);if(!m)return y("Site details not found",404);let T=await (0,l.DM)();if(!T?.env?.WEBFLOW_AUTHENTICATION)return console.error("KV binding missing or misconfigured"),y("Internal server error: KV binding missing",500);let x=`script-categories:${m.siteId}`,C=await T.env.WEBFLOW_AUTHENTICATION.get(x);if(!C){let{key:e,iv:t}=await c.X.generateKey(),r=await c.X.encrypt(JSON.stringify({scripts:[],message:"No script categories found for this site"}),e,t),n=await crypto.subtle.exportKey("raw",e);return p(new a.NextResponse(JSON.stringify({encryptedData:r,key:Array.from(new Uint8Array(n)),iv:Array.from(t)}),{status:200}))}try{let e=JSON.parse(C),{key:t,iv:r}=await c.X.generateKey(),n=await c.X.encrypt(JSON.stringify({scripts:e,visitorId:h}),t,r),o=await crypto.subtle.exportKey("raw",t);return p(new a.NextResponse(JSON.stringify({encryptedData:n,key:Array.from(new Uint8Array(o)),iv:Array.from(r)}),{status:200}))}catch(e){return console.error("Failed to parse script data:",e),y("Error parsing script categories",500)}}catch(e){return console.error("Unexpected error in POST handler:",e),y("Internal server error",500)}}let A=new o.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/cmp/script-category/route",pathname:"/api/cmp/script-category",filename:"route",bundlePath:"app/api/cmp/script-category/route"},resolvedPagePath:"C:\\Seattle\\Cookie App\\Consernbit-Cloudflare-Server-Test\\cb-server\\app\\api\\cmp\\script-category\\route.ts",nextConfigOutput:"standalone",userland:n}),{workAsyncStorage:w,workUnitAsyncStorage:h,serverHooks:m}=A;function T(){return(0,s.patchFetch)({workAsyncStorage:w,workUnitAsyncStorage:h})}},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},94337:(e,t,r)=>{"use strict";r.d(t,{X:()=>n});let n={generateKey:async()=>({key:await crypto.subtle.generateKey({name:"AES-GCM",length:256},!0,["encrypt","decrypt"]),iv:crypto.getRandomValues(new Uint8Array(12))}),importKey:async(e,t=["encrypt","decrypt"])=>await crypto.subtle.importKey("raw",e,{name:"AES-GCM"},!1,t),async encrypt(e,t,r){let n=new TextEncoder().encode(e);return btoa(String.fromCharCode(...new Uint8Array(await crypto.subtle.encrypt({name:"AES-GCM",iv:r},t,n))))},async decrypt(e,t,r){let n=Uint8Array.from(atob(e),e=>e.charCodeAt(0)),o=await crypto.subtle.decrypt({name:"AES-GCM",iv:r},t,n);return new TextDecoder().decode(o)}}},96487:()=>{},97130:(e,t,r)=>{"use strict";r.d(t,{A:()=>o});var n=r(6426);async function o(e){try{let{env:t}=await (0,n.DM)({async:!0});if(!t?.WEBFLOW_AUTHENTICATION)return console.error("KV binding missing"),null;let r=await t.WEBFLOW_AUTHENTICATION.list();for(let n of(console.log("siteName",e),console.log("ev keys",r),r.keys)){let r=await t.WEBFLOW_AUTHENTICATION.get(n.name);if(r){let t=JSON.parse(r);if(t.siteName===e)return{...t,siteId:n.name}}}return null}catch(e){return console.error("Error finding site details:",e),null}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[297,190],()=>r(21775));module.exports=n})();