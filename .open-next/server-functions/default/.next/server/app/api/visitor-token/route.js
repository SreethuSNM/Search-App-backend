(()=>{var e={};e.id=464,e.ids=[464],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},30029:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>y,routeModule:()=>w,serverHooks:()=>f,workAsyncStorage:()=>H,workUnitAsyncStorage:()=>g});var s={};r.r(s),r.d(s,{OPTIONS:()=>p,POST:()=>h});var o=r(96559),n=r(48088),a=r(37719),i=r(32190),d=r(87806),c=r(97130),u=r(6426);function l(e,t){return t&&(e.headers.set("Access-Control-Allow-Origin",t),e.headers.set("Access-Control-Allow-Methods","GET, POST, OPTIONS"),e.headers.set("Access-Control-Allow-Headers","Content-Type, Authorization")),e}async function p(e){let t=e.headers.get("origin");return l(new i.NextResponse(null,{status:204}),t)}async function h(e){let t=e.headers.get("origin");try{let{visitorId:r,userAgent:s,siteName:o}=await e.json();if(console.log(" visitor-token",r,s,o),!r||!o)return l(i.NextResponse.json({error:"Visitor ID and site name are required"},{status:400}),t);let n=await (0,c.A)(o);if(!n)return l(i.NextResponse.json({error:"Site not found"},{status:404}),t);let a=await new d.P({visitorId:r,userAgent:s,siteName:o,timestamp:Date.now()}).setProtectedHeader({alg:"HS256"}).setExpirationTime("24h").sign(new TextEncoder().encode(n.accessToken)),{env:p}=await (0,u.DM)();if(!p?.WEBFLOW_AUTHENTICATION)return l(i.NextResponse.json({error:"KV binding missing"},{status:500}),t);let h=`visitor-token:${o}`;return await p.WEBFLOW_AUTHENTICATION.put(h,a,{expirationTtl:86400}),l(i.NextResponse.json({token:a,visitorId:r}),t)}catch(e){return console.error("Error generating visitor token:",e),l(i.NextResponse.json({error:"Internal server error"},{status:500}),t)}}let w=new o.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/visitor-token/route",pathname:"/api/visitor-token",filename:"route",bundlePath:"app/api/visitor-token/route"},resolvedPagePath:"C:\\Seattle\\Cookie App\\Consernbit-Cloudflare-Server-Test\\cb-server\\app\\api\\visitor-token\\route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:H,workUnitAsyncStorage:g,serverHooks:f}=w;function y(){return(0,a.patchFetch)({workAsyncStorage:H,workUnitAsyncStorage:g})}},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},87806:(e,t,r)=>{"use strict";r.d(t,{P:()=>f});var s=r(21187),o=r(16263),n=r(92120),a=r(4208);let i=async(e,t,r)=>{let s=await (0,a.A)(e,t,"sign");return(0,n.A)(e,s),new Uint8Array(await crypto.subtle.sign((0,o.A)(e,s.algorithm),s,r))};var d=r(74996),c=r(70803),u=r(97989),l=r(44032),p=r(41286),h=r(95548);class w{#e;#t;#r;constructor(e){if(!(e instanceof Uint8Array))throw TypeError("payload must be an instance of Uint8Array");this.#e=e}setProtectedHeader(e){if(this.#t)throw TypeError("setProtectedHeader can only be called once");return this.#t=e,this}setUnprotectedHeader(e){if(this.#r)throw TypeError("setUnprotectedHeader can only be called once");return this.#r=e,this}async sign(e,t){let r;if(!this.#t&&!this.#r)throw new c.Ye("either setProtectedHeader or setUnprotectedHeader must be called before #sign()");if(!(0,d.A)(this.#t,this.#r))throw new c.Ye("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let o={...this.#t,...this.#r},n=(0,p.A)(c.Ye,new Map([["b64",!0]]),t?.crit,this.#t,o),a=!0;if(n.has("b64")&&"boolean"!=typeof(a=this.#t.b64))throw new c.Ye('The "b64" (base64url-encode payload) Header Parameter must be a boolean');let{alg:w}=o;if("string"!=typeof w||!w)throw new c.Ye('JWS "alg" (Algorithm) Header Parameter missing or invalid');(0,l.A)(w,e,"sign");let H=this.#e;a&&(H=u.Rd.encode((0,s.l)(H))),r=this.#t?u.Rd.encode((0,s.l)(JSON.stringify(this.#t))):u.Rd.encode("");let g=(0,u.xW)(r,u.Rd.encode("."),H),f=await (0,h.A)(e,w),y=await i(w,f,g),A={signature:(0,s.l)(y),payload:""};return a&&(A.payload=u.D0.decode(H)),this.#r&&(A.header=this.#r),this.#t&&(A.protected=u.D0.decode(r)),A}}class H{#s;constructor(e){this.#s=new w(e)}setProtectedHeader(e){return this.#s.setProtectedHeader(e),this}async sign(e,t){let r=await this.#s.sign(e,t);if(void 0===r.payload)throw TypeError("use the flattened module for creating JWS with b64: false");return`${r.protected}.${r.payload}.${r.signature}`}}var g=r(91492);class f{#t;#o;constructor(e={}){this.#o=new g.c(e)}setIssuer(e){return this.#o.iss=e,this}setSubject(e){return this.#o.sub=e,this}setAudience(e){return this.#o.aud=e,this}setJti(e){return this.#o.jti=e,this}setNotBefore(e){return this.#o.nbf=e,this}setExpirationTime(e){return this.#o.exp=e,this}setIssuedAt(e){return this.#o.iat=e,this}setProtectedHeader(e){return this.#t=e,this}async sign(e,t){let r=new H(this.#o.data());if(r.setProtectedHeader(this.#t),Array.isArray(this.#t?.crit)&&this.#t.crit.includes("b64")&&!1===this.#t.b64)throw new c.Dp("JWTs MUST NOT use unencoded payload");return r.sign(e,t)}}},96487:()=>{},97130:(e,t,r)=>{"use strict";r.d(t,{A:()=>o});var s=r(6426);async function o(e){try{let{env:t}=await (0,s.DM)({async:!0});if(!t?.WEBFLOW_AUTHENTICATION)return console.error("KV binding missing"),null;let r=await t.WEBFLOW_AUTHENTICATION.list();for(let s of(console.log("siteName",e),console.log("ev keys",r),r.keys)){let r=await t.WEBFLOW_AUTHENTICATION.get(s.name);if(r){let t=JSON.parse(r);if(t.siteName===e)return{...t,siteId:s.name}}}return null}catch(e){return console.error("Error finding site details:",e),null}}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[297,190,699],()=>r(30029));module.exports=s})();