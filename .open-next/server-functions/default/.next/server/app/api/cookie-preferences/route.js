(()=>{var e={};e.id=557,e.ids=[557],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46509:(e,t,r)=>{"use strict";r.d(t,{A:()=>n});var o=r(87806),s=r(77412),a=r(6426);let n={createSessionToken:async e=>{let t=new TextEncoder().encode(process.env.CLIENT_SECRET),r=await new o.P({user:e}).setProtectedHeader({alg:"HS256"}).setExpirationTime("24h").sign(t),a=await (0,s.V)(r,t);return console.log("____inside create session_____ ",r),{sessionToken:r,exp:a.payload.exp}},verifyAuth:async e=>{let t=e.headers.get("authorization");console.log("authheader",t);let r=t?.split(" ")[1];if(console.log("session token",r),console.log("inside verify auth session",r),!r)return null;try{let e=new TextEncoder().encode(process.env.CLIENT_SECRET),{payload:t}=await (0,s.V)(r,e),o=t.user.id,{env:n}=await (0,a.DM)({async:!0}),i=await n.WEBFLOW_AUTHENTICATION.get(`user-auth:${o}`);if(i){let e=JSON.parse(i);return console.log("inside verify auth access token",e.accessToken),e.accessToken}return null}catch{return null}},getAccessToken:async e=>{try{let t=null;if("POST"===e.method?(t=(await e.json()).siteId,console.log("siteId",t)):"GET"===e.method&&(t=e.nextUrl.searchParams.get("siteId"),console.log("siteId in params",t)),!t)return console.error("No siteId provided in request."),null;let{env:r}=await (0,a.DM)({async:!0}),o=await r.WEBFLOW_AUTHENTICATION.get(t);if(console.log("stored info in kv",o),o)return JSON.parse(o).accessToken;return console.error(`No access token found for site ${t}`),null}catch(e){return console.error("Error getting access token:",e),null}},getSiteIdFromAccessToken:async e=>{try{let{env:t}=await (0,a.DM)({async:!0});for(let r of(await t.WEBFLOW_AUTHENTICATION.list()).keys){let o=await t.WEBFLOW_AUTHENTICATION.get(r.name);if(o&&JSON.parse(o).accessToken===e)return String(r.name)}return null}catch(e){return console.error("Error getting site ID:",e),null}}}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},67892:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>A,routeModule:()=>f,serverHooks:()=>g,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>w});var o={};r.r(o),r.d(o,{GET:()=>h,OPTIONS:()=>u,POST:()=>p});var s=r(96559),a=r(48088),n=r(37719),i=r(32190),d=r(6426),c=r(46509);function l(e){return e.headers.set("Access-Control-Allow-Origin","*"),e.headers.set("Access-Control-Allow-Methods","GET, POST, OPTIONS"),e.headers.set("Access-Control-Allow-Headers","Content-Type, Authorization"),e}async function u(){return l(new i.NextResponse(null,{status:204}))}async function p(e){try{let t=await c.A.verifyAuth(e);if(!t)return l(i.NextResponse.json({error:"Unauthorized"},{status:401}));let r=await c.A.getSiteIdFromAccessToken(t);if(!r)return l(i.NextResponse.json({error:"Unauthorized",details:"SiteId not found"},{status:401}));let{visitorId:o,preferences:s,timestamp:a}=await e.json();if(!o||!s||!a)return l(i.NextResponse.json({error:"Missing required fields"},{status:400}));let{env:n}=(0,d.DM)();if(!n)return l(i.NextResponse.json({error:"Cloudflare environment not available"},{status:500}));let u=`cookie-preferences:${r}:${o}`;return await n.WEBFLOW_AUTHENTICATION.put(u,JSON.stringify({preferences:s,timestamp:a,lastUpdated:new Date().toISOString()})),l(i.NextResponse.json({success:!0}))}catch(e){return console.error("Error saving cookie preferences:",e),l(i.NextResponse.json({error:"Failed to save preferences"},{status:500}))}}async function h(e){try{let t=await c.A.verifyAuth(e);if(!t)return l(i.NextResponse.json({error:"Unauthorized"},{status:401}));let r=await c.A.getSiteIdFromAccessToken(t);if(!r)return l(i.NextResponse.json({error:"Unauthorized",details:"SiteId not found"},{status:401}));let o=e.nextUrl.searchParams.get("visitorId");if(!o)return l(i.NextResponse.json({error:"Visitor ID is required"},{status:400}));let s=`cookie-preferences:${r}:${o}`,{env:a}=(0,d.DM)();if(!a)return l(i.NextResponse.json({error:"Cloudflare environment not available"},{status:500}));let n=await a.WEBFLOW_AUTHENTICATION.get(s);if(!n)return l(i.NextResponse.json({success:!1,message:"No preferences found for this visitor",data:null}));try{let e=JSON.parse(n);return l(i.NextResponse.json({success:!0,message:"Preferences retrieved successfully",data:e}))}catch(e){return console.error("Error parsing preferences:",e),l(i.NextResponse.json({success:!1,error:"Error parsing preferences",message:"Failed to parse stored preferences"},{status:500}))}}catch(e){return console.error("Error retrieving cookie preferences:",e),l(i.NextResponse.json({success:!1,error:"Failed to retrieve preferences",message:"An unexpected error occurred"},{status:500}))}}let f=new s.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/cookie-preferences/route",pathname:"/api/cookie-preferences",filename:"route",bundlePath:"app/api/cookie-preferences/route"},resolvedPagePath:"C:\\Seattle\\Cookie App\\Consernbit-Cloudflare-Server-Test\\cb-server\\app\\api\\cookie-preferences\\route.ts",nextConfigOutput:"standalone",userland:o}),{workAsyncStorage:y,workUnitAsyncStorage:w,serverHooks:g}=f;function A(){return(0,n.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:w})}},77412:(e,t,r)=>{"use strict";r.d(t,{V:()=>m});var o=r(21187),s=r(16263),a=r(92120),n=r(4208);let i=async(e,t,r,o)=>{let i=await (0,n.A)(e,t,"verify");(0,a.A)(e,i);let d=(0,s.A)(e,i.algorithm);try{return await crypto.subtle.verify(d,i,r,o)}catch{return!1}};var d=r(70803),c=r(97989),l=r(74996),u=r(89531),p=r(44032),h=r(41286);let f=(e,t)=>{if(void 0!==t&&(!Array.isArray(t)||t.some(e=>"string"!=typeof e)))throw TypeError(`"${e}" option must be an array of strings`);if(t)return new Set(t)};var y=r(95548);async function w(e,t,r){let s,a;if(!(0,u.A)(e))throw new d.Ye("Flattened JWS must be an object");if(void 0===e.protected&&void 0===e.header)throw new d.Ye('Flattened JWS must have either of the "protected" or "header" members');if(void 0!==e.protected&&"string"!=typeof e.protected)throw new d.Ye("JWS Protected Header incorrect type");if(void 0===e.payload)throw new d.Ye("JWS Payload missing");if("string"!=typeof e.signature)throw new d.Ye("JWS Signature missing or incorrect type");if(void 0!==e.header&&!(0,u.A)(e.header))throw new d.Ye("JWS Unprotected Header incorrect type");let n={};if(e.protected)try{let t=(0,o.D)(e.protected);n=JSON.parse(c.D0.decode(t))}catch{throw new d.Ye("JWS Protected Header is invalid")}if(!(0,l.A)(n,e.header))throw new d.Ye("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let w={...n,...e.header},g=(0,h.A)(d.Ye,new Map([["b64",!0]]),r?.crit,n,w),A=!0;if(g.has("b64")&&"boolean"!=typeof(A=n.b64))throw new d.Ye('The "b64" (base64url-encode payload) Header Parameter must be a boolean');let{alg:m}=w;if("string"!=typeof m||!m)throw new d.Ye('JWS "alg" (Algorithm) Header Parameter missing or invalid');let H=r&&f("algorithms",r.algorithms);if(H&&!H.has(m))throw new d.Rb('"alg" (Algorithm) Header Parameter value not allowed');if(A){if("string"!=typeof e.payload)throw new d.Ye("JWS Payload must be a string")}else if("string"!=typeof e.payload&&!(e.payload instanceof Uint8Array))throw new d.Ye("JWS Payload must be a string or an Uint8Array instance");let v=!1;"function"==typeof t&&(t=await t(n,e),v=!0),(0,p.A)(m,t,"verify");let T=(0,c.xW)(c.Rd.encode(e.protected??""),c.Rd.encode("."),"string"==typeof e.payload?c.Rd.encode(e.payload):e.payload);try{s=(0,o.D)(e.signature)}catch{throw new d.Ye("Failed to base64url decode the signature")}let S=await (0,y.A)(t,m);if(!await i(m,S,s,T))throw new d.h2;if(A)try{a=(0,o.D)(e.payload)}catch{throw new d.Ye("Failed to base64url decode the payload")}else a="string"==typeof e.payload?c.Rd.encode(e.payload):e.payload;let b={payload:a};return(void 0!==e.protected&&(b.protectedHeader=n),void 0!==e.header&&(b.unprotectedHeader=e.header),v)?{...b,key:S}:b}async function g(e,t,r){if(e instanceof Uint8Array&&(e=c.D0.decode(e)),"string"!=typeof e)throw new d.Ye("Compact JWS must be a string or Uint8Array");let{0:o,1:s,2:a,length:n}=e.split(".");if(3!==n)throw new d.Ye("Invalid Compact JWS");let i=await w({payload:s,protected:o,signature:a},t,r),l={payload:i.payload,protectedHeader:i.protectedHeader};return"function"==typeof t?{...l,key:i.key}:l}var A=r(91492);async function m(e,t,r){let o=await g(e,t,r);if(o.protectedHeader.crit?.includes("b64")&&!1===o.protectedHeader.b64)throw new d.Dp("JWTs MUST NOT use unencoded payload");let s={payload:(0,A.k)(o.protectedHeader,o.payload,r),protectedHeader:o.protectedHeader};return"function"==typeof t?{...s,key:o.key}:s}},78335:()=>{},87806:(e,t,r)=>{"use strict";r.d(t,{P:()=>g});var o=r(21187),s=r(16263),a=r(92120),n=r(4208);let i=async(e,t,r)=>{let o=await (0,n.A)(e,t,"sign");return(0,a.A)(e,o),new Uint8Array(await crypto.subtle.sign((0,s.A)(e,o.algorithm),o,r))};var d=r(74996),c=r(70803),l=r(97989),u=r(44032),p=r(41286),h=r(95548);class f{#e;#t;#r;constructor(e){if(!(e instanceof Uint8Array))throw TypeError("payload must be an instance of Uint8Array");this.#e=e}setProtectedHeader(e){if(this.#t)throw TypeError("setProtectedHeader can only be called once");return this.#t=e,this}setUnprotectedHeader(e){if(this.#r)throw TypeError("setUnprotectedHeader can only be called once");return this.#r=e,this}async sign(e,t){let r;if(!this.#t&&!this.#r)throw new c.Ye("either setProtectedHeader or setUnprotectedHeader must be called before #sign()");if(!(0,d.A)(this.#t,this.#r))throw new c.Ye("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let s={...this.#t,...this.#r},a=(0,p.A)(c.Ye,new Map([["b64",!0]]),t?.crit,this.#t,s),n=!0;if(a.has("b64")&&"boolean"!=typeof(n=this.#t.b64))throw new c.Ye('The "b64" (base64url-encode payload) Header Parameter must be a boolean');let{alg:f}=s;if("string"!=typeof f||!f)throw new c.Ye('JWS "alg" (Algorithm) Header Parameter missing or invalid');(0,u.A)(f,e,"sign");let y=this.#e;n&&(y=l.Rd.encode((0,o.l)(y))),r=this.#t?l.Rd.encode((0,o.l)(JSON.stringify(this.#t))):l.Rd.encode("");let w=(0,l.xW)(r,l.Rd.encode("."),y),g=await (0,h.A)(e,f),A=await i(f,g,w),m={signature:(0,o.l)(A),payload:""};return n&&(m.payload=l.D0.decode(y)),this.#r&&(m.header=this.#r),this.#t&&(m.protected=l.D0.decode(r)),m}}class y{#o;constructor(e){this.#o=new f(e)}setProtectedHeader(e){return this.#o.setProtectedHeader(e),this}async sign(e,t){let r=await this.#o.sign(e,t);if(void 0===r.payload)throw TypeError("use the flattened module for creating JWS with b64: false");return`${r.protected}.${r.payload}.${r.signature}`}}var w=r(91492);class g{#t;#s;constructor(e={}){this.#s=new w.c(e)}setIssuer(e){return this.#s.iss=e,this}setSubject(e){return this.#s.sub=e,this}setAudience(e){return this.#s.aud=e,this}setJti(e){return this.#s.jti=e,this}setNotBefore(e){return this.#s.nbf=e,this}setExpirationTime(e){return this.#s.exp=e,this}setIssuedAt(e){return this.#s.iat=e,this}setProtectedHeader(e){return this.#t=e,this}async sign(e,t){let r=new y(this.#s.data());if(r.setProtectedHeader(this.#t),Array.isArray(this.#t?.crit)&&this.#t.crit.includes("b64")&&!1===this.#t.b64)throw new c.Dp("JWTs MUST NOT use unencoded payload");return r.sign(e,t)}}},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[297,190,699],()=>r(67892));module.exports=o})();