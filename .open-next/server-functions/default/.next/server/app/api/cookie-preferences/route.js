(()=>{var e={};e.id=557,e.ids=[557],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},9927:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>S,routeModule:()=>g,serverHooks:()=>T,workAsyncStorage:()=>h,workUnitAsyncStorage:()=>y});var s={};t.r(s),t.d(s,{GET:()=>f,POST:()=>d});var n=t(96559),o=t(48088),a=t(37719),i=t(32190),c=t(6426),u=t(46509),l=t(12472);function p(e){return e.headers.set("Access-Control-Allow-Origin","*"),e.headers.set("Access-Control-Allow-Methods","GET, POST, OPTIONS"),e.headers.set("Access-Control-Allow-Headers","Content-Type, Authorization, X-Request-ID"),l.E.addSecurityHeaders(e.headers),e}async function d(e){try{let r=await u.A.verifyAuth(e);if(!r)return p(i.NextResponse.json({error:"Unauthorized"},{status:401}));let t=await u.A.getSiteIdFromAccessToken(r);if(!t)return p(i.NextResponse.json({error:"Unauthorized",details:"SiteId not found"},{status:401}));let{visitorId:s,preferences:n,timestamp:o}=await e.json();if(!s||!n||!o)return p(i.NextResponse.json({error:"Missing required fields"},{status:400}));let{env:a}=(0,c.DM)();if(!a)return p(i.NextResponse.json({error:"Cloudflare environment not available"},{status:500}));let l=`cookie-preferences:${t}:${s}`;return await a.WEBFLOW_AUTHENTICATION.put(l,JSON.stringify({preferences:n,timestamp:o,lastUpdated:new Date().toISOString()})),p(i.NextResponse.json({success:!0}))}catch(e){return console.error("Error saving cookie preferences:",e),p(i.NextResponse.json({error:"Failed to save preferences"},{status:500}))}}async function f(e){try{let r=await u.A.verifyAuth(e);if(!r)return p(i.NextResponse.json({error:"Unauthorized"},{status:401}));let t=await u.A.getSiteIdFromAccessToken(r);if(!t)return p(i.NextResponse.json({error:"Unauthorized",details:"SiteId not found"},{status:401}));let s=e.nextUrl.searchParams.get("visitorId");if(!s)return p(i.NextResponse.json({error:"Visitor ID is required"},{status:400}));let n=`cookie-preferences:${t}:${s}`,{env:o}=(0,c.DM)();if(!o)return p(i.NextResponse.json({error:"Cloudflare environment not available"},{status:500}));let a=await o.WEBFLOW_AUTHENTICATION.get(n);if(!a)return p(i.NextResponse.json({success:!1,message:"No preferences found for this visitor",data:null}));try{let e=JSON.parse(a);return p(i.NextResponse.json({success:!0,message:"Preferences retrieved successfully",data:e}))}catch(e){return console.error("Error parsing preferences:",e),p(i.NextResponse.json({success:!1,error:"Error parsing preferences",message:"Failed to parse stored preferences"},{status:500}))}}catch(e){return console.error("Error retrieving cookie preferences:",e),p(i.NextResponse.json({success:!1,error:"Failed to retrieve preferences",message:"An unexpected error occurred"},{status:500}))}}let g=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/cookie-preferences/route",pathname:"/api/cookie-preferences",filename:"route",bundlePath:"app/api/cookie-preferences/route"},resolvedPagePath:"C:\\Seattle\\Cookie App\\Consernbit-Cloudflare-Server-Test\\cb-server\\app\\api\\cookie-preferences\\route.ts",nextConfigOutput:"standalone",userland:s}),{workAsyncStorage:h,workUnitAsyncStorage:y,serverHooks:T}=g;function S(){return(0,a.patchFetch)({workAsyncStorage:h,workUnitAsyncStorage:y})}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},12472:(e,r,t)=>{"use strict";t.d(r,{E:()=>o});var s=t(55511),n=t.n(s);class o{static{this.SENSITIVE_FIELDS=["script","apiKey","secret","password","token"]}static sanitizeScript(e){let r={url:e.url,category:e.category,name:e.name,id:this.generateScriptId(e)};return this.SENSITIVE_FIELDS.forEach(e=>{e in r&&delete r[e]}),r}static generateScriptId(e){let r=`${e.url||""}${e.name||""}${e.category||""}`;return n().createHash("sha256").update(r).digest("hex")}static validateScript(e){if(!e)return!1;if(e.url)try{new URL(e.url)}catch{return!1}return(!e.category||"string"==typeof e.category)&&(!e.name||"string"==typeof e.name)}static sanitizeScripts(e){return e.filter(e=>this.validateScript(e)).map(e=>this.sanitizeScript(e))}static addSecurityHeaders(e){e.set("X-Content-Type-Options","nosniff"),e.set("X-Frame-Options","DENY"),e.set("X-XSS-Protection","1; mode=block"),e.set("Content-Security-Policy","default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"),e.set("Referrer-Policy","strict-origin-when-cross-origin")}}},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46509:(e,r,t)=>{"use strict";t.d(r,{A:()=>a});var s=t(87806),n=t(77412),o=t(6426);let a={createSessionToken:async e=>{let r=new TextEncoder().encode(process.env.CLIENT_SECRET),t=await new s.P({user:e}).setProtectedHeader({alg:"HS256"}).setExpirationTime("24h").sign(r),o=await (0,n.V)(t,r);return console.log("____inside create session_____ ",t),{sessionToken:t,exp:o.payload.exp}},verifyAuth:async e=>{let r=e.headers.get("authorization"),t=r?.split(" ")[1];if(console.log("inside verify auth session",t),!t)return null;try{let e=new TextEncoder().encode(process.env.WEBFLOW_CLIENT_SECRET),{payload:r}=await (0,n.V)(t,e),s=r.user.id,{env:a}=await (0,o.DM)({async:!0}),i=await a.WEBFLOW_AUTHENTICATION.get(`user-auth:${s}`);if(i){let e=JSON.parse(i);return console.log("inside verify auth access token",e.accessToken),e.accessToken}return null}catch{return null}},getAccessToken:async e=>{try{let r=null;if("POST"===e.method?(r=(await e.json()).siteId,console.log("siteId",r)):"GET"===e.method&&(r=e.nextUrl.searchParams.get("siteId"),console.log("siteId in params",r)),!r)return console.error("No siteId provided in request."),null;let{env:t}=await (0,o.DM)({async:!0}),s=await t.WEBFLOW_AUTHENTICATION.get(r);if(console.log("stored info in kv",s),s)return JSON.parse(s).accessToken;return console.error(`No access token found for site ${r}`),null}catch(e){return console.error("Error getting access token:",e),null}},getSiteIdFromAccessToken:async e=>{try{let{env:r}=await (0,o.DM)({async:!0});for(let t of(await r.WEBFLOW_AUTHENTICATION.list()).keys){let s=await r.WEBFLOW_AUTHENTICATION.get(t.name);if(s&&JSON.parse(s).accessToken===e)return String(t.name)}return null}catch(e){return console.error("Error getting site ID:",e),null}}}},55511:e=>{"use strict";e.exports=require("crypto")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},96487:()=>{}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[297,190,682],()=>t(9927));module.exports=s})();