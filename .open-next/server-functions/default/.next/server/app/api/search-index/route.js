(()=>{var e={};e.id=725,e.ids=[725],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4420:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>A,routeModule:()=>w,serverHooks:()=>m,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>x});var o={};r.r(o),r.d(o,{GET:()=>f,OPTIONS:()=>u});var a=r(96559),n=r(48088),s=r(37719),i=r(32190),l=r(22563),d=r(8898);function c(e){return e.headers.set("Access-Control-Allow-Origin","*"),e.headers.set("Access-Control-Allow-Methods","GET, POST, OPTIONS"),e.headers.set("Access-Control-Allow-Headers","Content-Type, Authorization"),e}async function u(){return c(new i.NextResponse(null,{status:204}))}async function p(e,t){let r=(await e.pages.list(t)).pages??[];if(!Array.isArray(r))throw Error("Pages should be an array.");let o={};return r.forEach(e=>{let t=e.title||e.slug,r=e.publishedPath||"";t&&(o[e.id]={title:t,publishedPath:r})}),{pages:r,pageTitleMap:o}}function y(e){if("object"==typeof e&&null!==e&&"text"in e){let t=e.text;return"string"==typeof t||"object"==typeof t&&null!==t&&"string"==typeof t.text}return!1}async function h(e,t,r,o){let a=((await e.pages.getContent(t,{})).nodes||[]).filter(y).map(e=>"string"==typeof e.text?e.text.trim():(e.text?.text||"").trim()).filter(Boolean).join("\n");return{pageId:t,title:o.title,publishedPath:o.publishedPath,text:a}}async function f(e){try{let t=await d.A.verifyAuth(e);if(!t)return c(i.NextResponse.json({error:"Unauthorized"},{status:401}));let{searchParams:r}=new URL(e.url),o=r.get("query")?.toLowerCase().trim(),a=r.get("siteId");if(!o)return c(i.NextResponse.json({error:"Search query is required"},{status:400}));if(!a)return c(i.NextResponse.json({error:"siteId is required"},{status:400}));let n=new l.WebflowClient({accessToken:t}),{pages:s,pageTitleMap:u}=await p(n,a),y=(await Promise.all(s.map(async e=>{try{return await h(n,e.id,a,u[e.id])}catch(t){return console.error(`Failed to index page ${e.id}`,t),null}}))).filter(Boolean).filter(e=>null!==e).map(e=>({pageId:e.pageId,title:e.title,publishedPath:e.publishedPath,matchedText:e.text}));return c(i.NextResponse.json({query:o,results:y}))}catch(e){return console.error("Search error:",e),c(i.NextResponse.json({error:"Internal server error"},{status:500}))}}let w=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/search-index/route",pathname:"/api/search-index",filename:"route",bundlePath:"app/api/search-index/route"},resolvedPagePath:"D:\\cloudBackend\\search-server\\app\\api\\search-index\\route.ts",nextConfigOutput:"standalone",userland:o}),{workAsyncStorage:g,workUnitAsyncStorage:x,serverHooks:m}=w;function A(){return(0,s.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:x})}},8898:(e,t,r)=>{"use strict";r.d(t,{A:()=>T});var o=r(87806),a=r(21187),n=r(16263),s=r(92120),i=r(4208);let l=async(e,t,r,o)=>{let a=await (0,i.A)(e,t,"verify");(0,s.A)(e,a);let l=(0,n.A)(e,a.algorithm);try{return await crypto.subtle.verify(l,a,r,o)}catch{return!1}};var d=r(70803),c=r(97989),u=r(74996),p=r(89531),y=r(44032),h=r(41286);let f=(e,t)=>{if(void 0!==t&&(!Array.isArray(t)||t.some(e=>"string"!=typeof e)))throw TypeError(`"${e}" option must be an array of strings`);if(t)return new Set(t)};var w=r(95548);async function g(e,t,r){let o,n;if(!(0,p.A)(e))throw new d.Ye("Flattened JWS must be an object");if(void 0===e.protected&&void 0===e.header)throw new d.Ye('Flattened JWS must have either of the "protected" or "header" members');if(void 0!==e.protected&&"string"!=typeof e.protected)throw new d.Ye("JWS Protected Header incorrect type");if(void 0===e.payload)throw new d.Ye("JWS Payload missing");if("string"!=typeof e.signature)throw new d.Ye("JWS Signature missing or incorrect type");if(void 0!==e.header&&!(0,p.A)(e.header))throw new d.Ye("JWS Unprotected Header incorrect type");let s={};if(e.protected)try{let t=(0,a.D)(e.protected);s=JSON.parse(c.D0.decode(t))}catch{throw new d.Ye("JWS Protected Header is invalid")}if(!(0,u.A)(s,e.header))throw new d.Ye("JWS Protected and JWS Unprotected Header Parameter names must be disjoint");let i={...s,...e.header},g=(0,h.A)(d.Ye,new Map([["b64",!0]]),r?.crit,s,i),x=!0;if(g.has("b64")&&"boolean"!=typeof(x=s.b64))throw new d.Ye('The "b64" (base64url-encode payload) Header Parameter must be a boolean');let{alg:m}=i;if("string"!=typeof m||!m)throw new d.Ye('JWS "alg" (Algorithm) Header Parameter missing or invalid');let A=r&&f("algorithms",r.algorithms);if(A&&!A.has(m))throw new d.Rb('"alg" (Algorithm) Header Parameter value not allowed');if(x){if("string"!=typeof e.payload)throw new d.Ye("JWS Payload must be a string")}else if("string"!=typeof e.payload&&!(e.payload instanceof Uint8Array))throw new d.Ye("JWS Payload must be a string or an Uint8Array instance");let v=!1;"function"==typeof t&&(t=await t(s,e),v=!0),(0,y.A)(m,t,"verify");let T=(0,c.xW)(c.Rd.encode(e.protected??""),c.Rd.encode("."),"string"==typeof e.payload?c.Rd.encode(e.payload):e.payload);try{o=(0,a.D)(e.signature)}catch{throw new d.Ye("Failed to base64url decode the signature")}let S=await (0,w.A)(t,m);if(!await l(m,S,o,T))throw new d.h2;if(x)try{n=(0,a.D)(e.payload)}catch{throw new d.Ye("Failed to base64url decode the payload")}else n="string"==typeof e.payload?c.Rd.encode(e.payload):e.payload;let b={payload:n};return(void 0!==e.protected&&(b.protectedHeader=s),void 0!==e.header&&(b.unprotectedHeader=e.header),v)?{...b,key:S}:b}async function x(e,t,r){if(e instanceof Uint8Array&&(e=c.D0.decode(e)),"string"!=typeof e)throw new d.Ye("Compact JWS must be a string or Uint8Array");let{0:o,1:a,2:n,length:s}=e.split(".");if(3!==s)throw new d.Ye("Invalid Compact JWS");let i=await g({payload:a,protected:o,signature:n},t,r),l={payload:i.payload,protectedHeader:i.protectedHeader};return"function"==typeof t?{...l,key:i.key}:l}var m=r(91492);async function A(e,t,r){let o=await x(e,t,r);if(o.protectedHeader.crit?.includes("b64")&&!1===o.protectedHeader.b64)throw new d.Dp("JWTs MUST NOT use unencoded payload");let a={payload:(0,m.k)(o.protectedHeader,o.payload,r),protectedHeader:o.protectedHeader};return"function"==typeof t?{...a,key:o.key}:a}var v=r(6426);let T={createSessionToken:async e=>{let t=new TextEncoder().encode(process.env.CLIENT_SECRET),r=await new o.P({user:e}).setProtectedHeader({alg:"HS256"}).setExpirationTime("24h").sign(t),a=await A(r,t);return console.log("____inside create session_____ ",r),{sessionToken:r,exp:a.payload.exp}},verifyAuth:async e=>{let t=e.headers.get("authorization");console.log("authheader",t);let r=t?.split(" ")[1];if(console.log("session token",r),console.log("inside verify auth session",r),!r)return null;try{let e=new TextEncoder().encode(process.env.CLIENT_SECRET),{payload:t}=await A(r,e),o=t.user.id,{env:a}=await (0,v.DM)({async:!0}),n=await a.WEBFLOW_AUTHENTICATION.get(`user-auth:${o}`);if(n){let e=JSON.parse(n);return console.log("inside verify auth access token",e.accessToken),e.accessToken}return null}catch{return null}},getAccessToken:async e=>{try{let t=null;if("POST"===e.method?(t=(await e.json()).siteId,console.log("siteId",t)):"GET"===e.method&&(t=e.nextUrl.searchParams.get("siteId"),console.log("siteId in params",t)),!t)return console.error("No siteId provided in request."),null;let{env:r}=await (0,v.DM)({async:!0}),o=await r.WEBFLOW_AUTHENTICATION.get(t);if(console.log("stored info in kv",o),o)return JSON.parse(o).accessToken;return console.error(`No access token found for site ${t}`),null}catch(e){return console.error("Error getting access token:",e),null}},getSiteIdFromAccessToken:async e=>{try{let{env:t}=await (0,v.DM)({async:!0});for(let r of(await t.WEBFLOW_AUTHENTICATION.list()).keys){let o=await t.WEBFLOW_AUTHENTICATION.get(r.name);if(o&&JSON.parse(o).accessToken===e)return String(r.name)}return null}catch(e){return console.error("Error getting site ID:",e),null}}}},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},78335:()=>{},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[297,190,595,563],()=>r(4420));module.exports=o})();