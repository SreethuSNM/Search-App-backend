(()=>{var e={};e.id=654,e.ids=[654],e.modules={3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},46509:(e,t,s)=>{"use strict";s.d(t,{A:()=>a});var r=s(87806),o=s(77412),n=s(6426);let a={createSessionToken:async e=>{let t=new TextEncoder().encode(process.env.CLIENT_SECRET),s=await new r.P({user:e}).setProtectedHeader({alg:"HS256"}).setExpirationTime("24h").sign(t),n=await (0,o.V)(s,t);return console.log("____inside create session_____ ",s),{sessionToken:s,exp:n.payload.exp}},verifyAuth:async e=>{let t=e.headers.get("authorization"),s=t?.split(" ")[1];if(console.log("inside verify auth session",s),!s)return null;try{let e=new TextEncoder().encode(process.env.WEBFLOW_CLIENT_SECRET),{payload:t}=await (0,o.V)(s,e),r=t.user.id,{env:a}=await (0,n.DM)({async:!0}),i=await a.WEBFLOW_AUTHENTICATION.get(`user-auth:${r}`);if(i){let e=JSON.parse(i);return console.log("inside verify auth access token",e.accessToken),e.accessToken}return null}catch{return null}},getAccessToken:async e=>{try{let t=null;if("POST"===e.method?(t=(await e.json()).siteId,console.log("siteId",t)):"GET"===e.method&&(t=e.nextUrl.searchParams.get("siteId"),console.log("siteId in params",t)),!t)return console.error("No siteId provided in request."),null;let{env:s}=await (0,n.DM)({async:!0}),r=await s.WEBFLOW_AUTHENTICATION.get(t);if(console.log("stored info in kv",r),r)return JSON.parse(r).accessToken;return console.error(`No access token found for site ${t}`),null}catch(e){return console.error("Error getting access token:",e),null}},getSiteIdFromAccessToken:async e=>{try{let{env:t}=await (0,n.DM)({async:!0});for(let s of(await t.WEBFLOW_AUTHENTICATION.list()).keys){let r=await t.WEBFLOW_AUTHENTICATION.get(s.name);if(r&&JSON.parse(r).accessToken===e)return String(s.name)}return null}catch(e){return console.error("Error getting site ID:",e),null}}}},56636:(e,t,s)=>{"use strict";s.r(t),s.d(t,{patchFetch:()=>N,routeModule:()=>T,serverHooks:()=>k,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>h});var r={};s.r(r),s.d(r,{OPTIONS:()=>d,POST:()=>p});var o=s(96559),n=s(48088),a=s(37719),i=s(32190),l=s(6426),c=s(46509);let u={"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization","Access-Control-Max-Age":"86400"};async function d(){return new i.NextResponse(null,{status:204,headers:u})}async function p(e){let{env:t}=await (0,l.DM)({async:!0});try{let{siteId:s,idToken:r}=await e.json();if(console.log("siteId",s),console.log("idToken",r),!s||!r)return i.NextResponse.json({error:"Missing siteId or idToken"},{status:400,headers:u});let o=new Request(e.url,{method:"POST",headers:e.headers,body:JSON.stringify({siteId:s})});console.log("Requesting access token");let n=await c.A.getAccessToken(o);if(console.log("accessToken:",n),!n)return i.NextResponse.json({error:"Unauthorized"},{status:401,headers:u});console.log("Requesting resolve token");let a=await fetch("https://api.webflow.com/beta/token/resolve",{method:"POST",headers:{Accept:"application/json","Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({idToken:r})});if(console.log("Requesting resolve token response",a),!a.ok){let e=await a.json();return console.error("Webflow API error:",e),i.NextResponse.json({error:"Failed to verify user"},{status:401,headers:u})}let l=await a.json();if(console.log("userdata",l),!l.id||!l.email)return i.NextResponse.json({error:"Invalid user data received"},{status:400,headers:u});let d=await c.A.createSessionToken({id:l.id,email:l.email});await Promise.all([t.WEBFLOW_AUTHENTICATION.put(`user-auth:${l.id}`,JSON.stringify({accessToken:n,userData:{id:l.id,email:l.email,firstName:l.firstName}}),{expirationTtl:86400}),t.WEBFLOW_AUTHENTICATION.put(`site-auth:${s}`,JSON.stringify({accessToken:n,siteName:"consentbits-stellar-site"}),{expirationTtl:86400})]);let p=await t.WEBFLOW_AUTHENTICATION.get(`site-auth:${s}`);console.log("Verified stored site auth:",p);let T=i.NextResponse.json({sessionToken:d.sessionToken,email:l.email,firstName:l.firstName,exp:d.exp},{headers:u});return console.log("Response Token Data:",{sessionToken:d.sessionToken,email:l.email,firstName:l.firstName,exp:d.exp}),T}catch(e){return console.error("Error processing token request:",e),i.NextResponse.json({error:"Error processing authentication request"},{status:500,headers:u})}}let T=new o.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/auth/token/route",pathname:"/api/auth/token",filename:"route",bundlePath:"app/api/auth/token/route"},resolvedPagePath:"C:\\Seattle\\Cookie App\\Consernbit-Cloudflare-Server-Test\\cb-server\\app\\api\\auth\\token\\route.ts",nextConfigOutput:"standalone",userland:r}),{workAsyncStorage:g,workUnitAsyncStorage:h,serverHooks:k}=T;function N(){return(0,a.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:h})}},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78335:()=>{},96487:()=>{}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[297,190,682],()=>s(56636));module.exports=r})();